<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HISTORIAL_CLINICO_NUBE | DECLARACIÓN</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; text-transform: uppercase; padding: 20px; }
        .form-container { max-width: 1000px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .form-control, .form-select { background-color: #f3f6f9; border: none; border-radius: 10px; padding: 12px; font-weight: 600; font-size: 13px; }
        .seccion-titulo { background: #1e293b; color: white; padding: 10px 20px; border-radius: 10px; margin: 20px 0; font-weight: 800; }
        .btn-finalizar { background: #1e293b; color: white; border: none; border-radius: 15px; padding: 20px; width: 100%; font-weight: 800; margin-top: 30px; }
    </style>
</head>
<body>

    <div class="form-container">
        <h2 class="text-center fw-bold mb-4">DECLARACIÓN JURADA DE SALUD</h2>
        
        <form id="formFinal">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="fw-bold small">PACIENTE:</label>
                    <input type="text" id="display_nombre" class="form-control" readonly>
                </div>
                <div class="col-md-6">
                    <label class="fw-bold small">ID SISTEMA:</label>
                    <input type="text" id="display_id" class="form-control" readonly>
                </div>
            </div>

            <div class="seccion-titulo">3.1 HÁBITOS</div>
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="small fw-bold">ALCOHOL (SI/NO)</label>
                    <select id="h_alc_sn" class="form-select"><option value="NO">NO</option><option value="SI">SI</option></select>
                </div>
                <div class="col-md-4">
                    <label class="small fw-bold">CANTIDAD</label>
                    <input type="text" id="h_alc_cant" class="form-control" placeholder="0">
                </div>
                <div class="col-md-4">
                    <label class="small fw-bold">FRECUENCIA</label>
                    <input type="text" id="h_alc_freq" class="form-control" placeholder="NINGUNA">
                </div>
            </div>

            <div class="seccion-titulo">3.2 ANTECEDENTES OCUPACIONALES</div>
            <textarea id="historia_laboral" class="form-control" rows="3" placeholder="DESCRIPCIÓN DE TRABAJOS ANTERIORES"></textarea>

            <div class="seccion-titulo">3.3 RIESGOS EXPUESTOS</div>
            <div class="row g-2">
                <div class="col-md-3"><label class="small">RUIDO</label><input type="text" id="r_ruido" class="form-control" value="NO"></div>
                <div class="col-md-3"><label class="small">POLVO</label><input type="text" id="r_polvo" class="form-control" value="NO"></div>
                <div class="col-md-3"><label class="small">QUÍMICOS</label><input type="text" id="r_gases" class="form-control" value="NO"></div>
                <div class="col-md-3"><label class="small">OTROS</label><input type="text" id="r_otros" class="form-control" value="NO"></div>
            </div>

            <div class="mt-4">
                <label class="fw-bold small">OBSERVACIONES GENERALES</label>
                <input type="text" id="observaciones" class="form-control">
            </div>

            <button type="submit" class="btn-finalizar">FINALIZAR Y GUARDAR EN NUBE</button>
        </form>
    </div>

    <script>
        // SOLUCIÓN AL ERROR 405: URL absoluta y correcta del backend
        const URL_BACKEND = "https://historial-clinico-936s.onrender.com/declaraciones/";

        window.onload = () => {
            document.getElementById('display_nombre').value = localStorage.getItem('temp_nombres_completos') || "NO IDENTIFICADO";
            document.getElementById('display_id').value = localStorage.getItem('temp_paciente_id') || "SIN ID";
        };

        document.getElementById('formFinal').onsubmit = async (e) => {
            e.preventDefault();

            const p_id = localStorage.getItem('temp_paciente_id');
            if (!p_id || p_id === "SIN ID") {
                alert("ERROR: NO SE ENCONTRÓ EL ID DEL PACIENTE. REGÍSTRELO NUEVAMENTE.");
                return;
            }

            // SOLUCIÓN AL ERROR 422: Objeto estructurado exactamente como pide FastAPI
            const datos = {
                paciente_id: parseInt(p_id),
                edad: 0, 
                sexo: "NO DEFINIDO",
                fecha_nacimiento: "2000-01-01",
                lugar_nacimiento: "NO", domicilio_av_calle: "NO", domicilio_numero: "NO", barrio: "NO", ciudad: "NO", pais: "NO", telefono: "NO", estado_civil: "NO", profesion_labor: "NO",
                vista: "NO", auditivo: "NO", respiratorios: "NO", cardio: "NO", digestivo: "NO", sangre: "NO", urinario: "NO", nervioso: "NO", psiquiatrico: "NO", oseo: "NO", metabolico: "NO", reuma: "NO", generales: "NO", piel: "NO", infecciones: "NO",
                alergia_med: "NO", alergia_ali: "NO",
                h_alc_sn: document.getElementById('h_alc_sn').value,
                h_alc_cant: document.getElementById('h_alc_cant').value || "0",
                h_alc_freq: document.getElementById('h_alc_freq').value || "NINGUNA",
                h_tab_sn: "NO", h_tab_cant: "0", h_tab_freq: "NO",
                h_coca_sn: "NO", h_coca_cant: "0", h_coca_freq: "NO",
                historia_laboral: document.getElementById('historia_laboral').value || "NINGUNA",
                r_ruido: document.getElementById('r_ruido').value,
                r_radiacion: "NO", r_vibracion: "NO", r_mecanicos: "NO", r_temperatura: "NO", 
                r_polvo: document.getElementById('r_polvo').value,
                r_humos: "NO", 
                r_gases: document.getElementById('r_gases').value,
                r_metales: "NO", r_plomo: "NO", r_repetitivos: "NO", r_carga: "NO", r_psicologico: "NO", r_biologico: "NO", r_altura: "NO", r_confinados: "NO", 
                r_otros: document.getElementById('r_otros').value,
                observaciones: document.getElementById('observaciones').value || "SIN OBSERVACIONES"
            };

            try {
                const response = await fetch(URL_BACKEND, {
                    method: 'POST',
                    mode: 'cors', // SOLUCIÓN AL ERROR DE CORS
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });

                if (response.ok) {
                    alert("¡ÉXITO! DATOS GUARDADOS EN LA NUBE.");
                    window.location.href = "index.html";
                } else {
                    const errorData = await response.json();
                    console.error("Detalle del error:", errorData);
                    alert("ERROR 422: EL SERVIDOR RECHAZÓ LOS DATOS. REVISA LA CONSOLA.");
                }
            } catch (err) {
                console.error("Error de red:", err);
                alert("ERROR DE CONEXIÓN: EL SERVIDOR NO RESPONDE.");
            }
        };
    </script>
</body>
</html>
