<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HC NUBE | Declaración Jurada</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; text-transform: uppercase; padding: 20px; }
        .form-container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .seccion-titulo { background: #1e293b; color: white; padding: 10px 20px; border-radius: 10px; margin: 20px 0; font-weight: 800; font-size: 14px; }
        .form-control, .form-select { background-color: #f3f6f9; border: none; border-radius: 10px; padding: 10px; font-weight: 600; font-size: 12px; }
        .btn-finalizar { background: #1e293b; color: white; border: none; border-radius: 15px; padding: 18px; width: 100%; font-weight: 800; margin-top: 30px; transition: 0.3s; }
        .btn-finalizar:hover { background: #24a174; }
    </style>
</head>
<body>

<div class="form-container">
    <h3 class="text-center fw-bold mb-4">DECLARACIÓN JURADA DE SALUD</h3>
    
    <form id="formDeclaracion">
        <div class="row g-3 mb-4">
            <div class="col-md-8">
                <label class="fw-bold small">PACIENTE:</label>
                <input type="text" id="nombre_paciente" class="form-control" readonly>
            </div>
            <div class="col-md-4">
                <label class="fw-bold small">ID SISTEMA:</label>
                <input type="text" id="id_paciente" class="form-control" readonly>
            </div>
        </div>

        <div class="seccion-titulo">3.1 HÁBITOS</div>
        <div class="row g-3">
            <div class="col-md-4">
                <label class="small fw-bold">ALCOHOL (SI/NO)</label>
                <select id="h_alc_sn" class="form-select"><option value="NO">NO</option><option value="SI">SI</option></select>
            </div>
            <div class="col-md-4">
                <label class="small fw-bold">CANTIDAD</label>
                <input type="text" id="h_alc_cant" class="form-control" placeholder="0">
            </div>
            <div class="col-md-4">
                <label class="small fw-bold">FRECUENCIA</label>
                <input type="text" id="h_alc_freq" class="form-control" placeholder="NINGUNA">
            </div>
        </div>

        <div class="seccion-titulo">3.2 ANTECEDENTES OCUPACIONALES</div>
        <textarea id="historia_laboral" class="form-control" rows="3" placeholder="DESCRIPCIÓN DE TRABAJOS ANTERIORES"></textarea>

        <div class="seccion-titulo">3.3 RIESGOS EXPUESTOS</div>
        <div class="row g-3">
            <div class="col-md-3"><label class="small fw-bold">RUIDO</label><input type="text" id="r_ruido" class="form-control" value="NO"></div>
            <div class="col-md-3"><label class="small fw-bold">POLVO</label><input type="text" id="r_polvo" class="form-control" value="NO"></div>
            <div class="col-md-3"><label class="small fw-bold">QUÍMICOS/GASES</label><input type="text" id="r_gases" class="form-control" value="NO"></div>
            <div class="col-md-3"><label class="small fw-bold">OTROS</label><input type="text" id="r_otros" class="form-control" value="NO"></div>
        </div>

        <div class="mt-4">
            <label class="fw-bold small">OBSERVACIONES GENERALES</label>
            <input type="text" id="observaciones" class="form-control" placeholder="NINGUNA">
        </div>

        <button type="submit" id="btnGuardar" class="btn-finalizar">FINALIZAR Y GUARDAR EN NUBE</button>
    </form>
</div>

<script>
    // URL CORRECTA DE TU BACKEND EN RENDER (SEGÚN TUS CAPTURAS)
    const URL_NUBE = "https://historial-clinico-936s.onrender.com/declaraciones/";

    window.onload = () => {
        // Recuperamos los datos que guardamos en registro_paciente.html
        document.getElementById('nombre_paciente').value = localStorage.getItem('temp_nombres_completos') || "PACIENTE NO IDENTIFICADO";
        document.getElementById('id_paciente').value = localStorage.getItem('temp_paciente_id') || "";
    };

    document.getElementById('formDeclaracion').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnGuardar');
        const p_id = document.getElementById('id_paciente').value;

        if (!p_id) {
            alert("ERROR: NO SE ENCONTRÓ EL ID DEL PACIENTE. REGÍSTRELO NUEVAMENTE.");
            return;
        }

        btn.innerText = "GUARDANDO EN NUBE...";
        btn.disabled = true;

        // Construimos el objeto EXACTO que pide tu schemas.py
        const datos = {
            paciente_id: parseInt(p_id),
            h_alc_sn: document.getElementById('h_alc_sn').value,
            h_alc_cant: document.getElementById('h_alc_cant').value || "0",
            h_alc_freq: document.getElementById('h_alc_freq').value || "NINGUNA",
            historia_laboral: document.getElementById('historia_laboral').value || "NINGUNA",
            r_ruido: document.getElementById('r_ruido').value,
            r_polvo: document.getElementById('r_polvo').value,
            r_gases: document.getElementById('r_gases').value,
            r_otros: document.getElementById('r_otros').value,
            observaciones: document.getElementById('observaciones').value || "SIN OBSERVACIONES"
        };

        try {
            const res = await fetch(URL_NUBE, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datos)
            });

            if (res.ok) {
                alert("¡DATOS GUARDADOS EXITOSAMENTE EN LA NUBE!");
                window.location.href = "index.html";
            } else {
                const errorLog = await res.json();
                console.error("Error del servidor:", errorLog);
                alert("ERROR AL GUARDAR: REVISA LOS DATOS.");
            }
        } catch (error) {
            console.error("Fallo de red:", error);
            alert("ERROR DE CONEXIÓN: EL SERVIDOR NO RESPONDE.");
        } finally {
            btn.innerText = "FINALIZAR Y GUARDAR EN NUBE";
            btn.disabled = false;
        }
    };
</script>
</body>
</html>
