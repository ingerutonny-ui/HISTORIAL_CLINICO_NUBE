<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HC NUBE | Declaración Jurada</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; padding: 20px; }
        .jurada-container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .form-label { font-size: 10px; font-weight: 700; color: #b0bac9; text-transform: uppercase; margin-top: 10px; }
        .form-control, .form-select { border-radius: 12px; background-color: #f3f6f9; border: none; font-size: 13px; }
        .btn-accion { background-color: #24a174; border: none; border-radius: 15px; padding: 15px; font-weight: 700; width: 100%; color: white; margin-top: 20px; }
        .step-content { display: none; }
        .step-active { display: block; }
    </style>
</head>
<body>
    <div class="jurada-container">
        <form id="formMaster">
            <div id="paso1" class="step-content step-active">
                <h5>I. FILIACIÓN</h5>
                <div class="row">
                    <div class="col-6"><label class="form-label">Edad</label><input type="number" name="edad" class="form-control" required></div>
                    <div class="col-6"><label class="form-label">Sexo</label><select name="sexo" class="form-select"><option>MASCULINO</option><option>FEMENINO</option></select></div>
                    <div class="col-6"><label class="form-label">Fecha Nac.</label><input type="date" name="fecha_nac" class="form-control" required></div>
                    <div class="col-6"><label class="form-label">Lugar Nac.</label><input type="text" name="lugar_nac" class="form-control" value="BOLIVIA"></div>
                </div>
                <input type="hidden" name="domicilio" value="CONOCIDO">
                <input type="hidden" name="n_casa" value="S/N">
                <input type="hidden" name="barrio" value="CONOCIDO">
                <input type="hidden" name="ciudad" value="CIUDAD">
                <input type="hidden" name="pais" value="BOLIVIA">
                <input type="hidden" name="telf" value="0">
                <input type="hidden" name="civil" value="SOLTERO/A">
                <input type="hidden" name="labor" value="TRABAJADOR">
                <button type="button" onclick="document.getElementById('paso1').classList.remove('step-active');document.getElementById('paso2').classList.add('step-active')" class="btn-accion">SIGUIENTE</button>
            </div>

            <div id="paso2" class="step-content">
                <h5>II. ANTECEDENTES</h5>
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">VISTA</label><input type="text" name="s_vista" class="form-control" value="NORMAL">
                        <label class="form-label">RESPIRATORIOS</label><input type="text" name="s_respira" class="form-control" value="NORMAL">
                        <label class="form-label">DIGESTIVOS</label><input type="text" name="s_digesta" class="form-control" value="NORMAL">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">ALERGIAS</label><input type="text" name="s_alergia" class="form-control" value="NINGUNA">
                        <label class="form-label">CIRUGÍAS</label><input type="text" name="s_cirugia" class="form-control" value="NINGUNA">
                        <label class="form-label">ACCIDENTES</label><input type="text" name="s_acc_lab" class="form-control" value="NINGUNO">
                    </div>
                </div>
                <button type="button" onclick="document.getElementById('paso2').classList.remove('step-active');document.getElementById('paso3').classList.add('step-active')" class="btn-accion">SIGUIENTE</button>
            </div>

            <div id="paso3" class="step-content">
                <h5>III. HÁBITOS Y RIESGOS</h5>
                <div class="row">
                    <div class="col-3">
                        <label class="form-label">¿Fuma?</label>
                        <select name="fuma_si_no" class="form-select"><option>NO</option><option>SI</option></select>
                    </div>
                    <div class="col-9">
                        <label class="form-label">Detalle</label><input type="text" name="fuma_detalle" class="form-control" value="NINGUNO">
                    </div>
                </div>
                <div class="mt-3">
                    <label class="form-label">Ant. Ocupacionales</label><textarea name="ant_ocupacional" class="form-control">NINGUNO</textarea>
                </div>
                <button type="submit" id="btnFinalizar" class="btn-accion">FINALIZAR Y GUARDAR</button>
            </div>
        </form>
    </div>

    <script>
        const API_BASE = 'https://historial-clinico-936s.onrender.com';

        document.getElementById('formMaster').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnFinalizar');
            btn.innerText = "ESPERE..."; btn.disabled = true;

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            // Rellenar campos faltantes por si acaso
            const camposMedicos = ["s_auditivo", "s_cardio", "s_nervio", "s_urina", "s_genital", "s_osteo", "s_piel", "s_infecto", "s_sangre", "s_endo", "s_hospi", "s_acc_com", "s_vacuna", "s_medica", "s_fam", "s_obs", "bebe_si_no", "bebe_detalle", "droga_si_no", "droga_detalle", "med_si_no", "med_detalle", "riesgo_fisico", "riesgo_quimico", "riesgo_ergo", "riesgo_psico", "riesgo_obs"];
            camposMedicos.forEach(c => { if(!data[c]) data[c] = "NINGUNO"; });

            data.edad = parseInt(data.edad) || 0;
            // OBLIGATORIO: Enviar el ID numérico
            data.paciente_id = parseInt(localStorage.getItem('temp_id'));

            try {
                const res = await fetch(`${API_BASE}/declaraciones/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    alert("✅ GUARDADO EXITOSO");
                    localStorage.clear();
                    window.location.href = "index.html";
                } else {
                    const err = await res.json();
                    alert("ERROR: " + JSON.stringify(err.detail));
                }
            } catch (err) { alert("FALLO DE CONEXIÓN. INTENTE OTRA VEZ."); }
            finally { btn.disabled = false; btn.innerText = "FINALIZAR Y GUARDAR"; }
        };
    </script>
</body>
</html>
