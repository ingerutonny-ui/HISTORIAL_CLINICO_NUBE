<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HC NUBE | Visor Profesional Sincronizado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-slate-950 min-h-screen text-slate-200 p-4 font-sans">

    <div class="max-w-2xl mx-auto mt-12 mb-12 flex justify-between items-center bg-slate-900/50 p-6 rounded-3xl border border-slate-800">
        <div>
            <h2 class="text-2xl font-black uppercase text-white tracking-tighter italic">Buscador de Historiales</h2>
            <p class="text-[10px] text-blue-400 uppercase tracking-widest font-bold">Sincronizaci√≥n en Tiempo Real - Secci√≥n IV</p>
        </div>
        <button onclick="location.href='index.html'" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-xl text-[10px] uppercase font-bold transition-all">‚Üê Salir</button>
    </div>

    <div class="max-w-md mx-auto mb-12">
        <div class="relative">
            <input type="text" id="codigoBusqueda" placeholder="INGRESE C√ìDIGO (Ej: RA3372)" 
                class="w-full bg-slate-900 border-2 border-slate-800 rounded-2xl py-5 px-8 text-center text-lg font-black tracking-widest text-blue-400 focus:outline-none focus:border-blue-500 uppercase transition-all shadow-2xl">
            <button onclick="buscarPaciente()" class="absolute right-3 top-3 bottom-3 px-6 bg-blue-600 hover:bg-blue-500 rounded-xl text-white font-bold transition-all shadow-lg shadow-blue-900/20">BUSCAR</button>
        </div>
    </div>

    <div id="resultadoVisor" class="hidden max-w-xl mx-auto animate-in fade-in zoom-in duration-500">
        <div class="bg-slate-900/80 backdrop-blur-xl rounded-[3rem] p-10 shadow-2xl text-center border border-slate-800">
            <div class="flex flex-col items-center mb-8">
                <div class="w-24 h-24 bg-emerald-500/10 rounded-full flex items-center justify-center text-4xl mb-6 border-2 border-emerald-500/30 text-emerald-400 shadow-inner">üë§</div>
                <h3 id="resNombre" class="text-3xl font-black text-white uppercase tracking-tighter leading-none mb-2">---</h3>
                <span id="resCodigo" class="px-6 py-2 bg-blue-500/10 border border-blue-500/40 rounded-full text-blue-400 text-xs font-black uppercase tracking-widest">---</span>
            </div>
            <button onclick="generarVistaPrevia()" class="w-full py-5 bg-emerald-600 hover:bg-emerald-500 rounded-2xl text-xs font-black uppercase tracking-[0.2em] text-white shadow-2xl shadow-emerald-900/40 transition-all active:scale-95">
                Generar PDF Profesional
            </button>
        </div>
    </div>

    <script>
        const API_BASE = 'https://historial-clinico-936s.onrender.com';
        let d = null; // Variable global para limpiar datos previos

        async function buscarPaciente() {
            const codigo = document.getElementById('codigoBusqueda').value.trim().toUpperCase();
            if (!codigo) return;
            try {
                const response = await fetch(`${API_BASE}/pacientes/`);
                const pacientes = await response.json();
                const p = pacientes.find(x => x.codigo_paciente.toUpperCase() === codigo);
                if (p) {
                    const resFull = await fetch(`${API_BASE}/historial-completo/${p.id}`);
                    d = await resFull.json(); // Cargamos datos frescos
                    document.getElementById('resNombre').textContent = `${d.paciente.nombres} ${d.paciente.apellidos}`.toUpperCase();
                    document.getElementById('resCodigo').textContent = d.paciente.codigo_paciente.toUpperCase();
                    document.getElementById('resultadoVisor').classList.remove('hidden');
                }
            } catch (e) { console.error("Error al buscar:", e); }
        }

        async function generarVistaPrevia() {
            if (!d) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');

            // FUNCI√ìN DE DETECCI√ìN AGRESIVA DE "SI"
            const marcarSi = (valor) => {
                if (!valor) return false;
                const v = String(valor).trim().toUpperCase();
                // Si el texto existe y no es uno de estos, se considera un "SI" con observaciones
                const negativos = ["NO", "N/A", "NORMAL", "NINGUNO", "---", "", "SIN RIESGOS", "NORMAL."];
                return !negativos.includes(v);
            };

            const drawHeader = (pdf) => {
                pdf.setFontSize(14); pdf.setFont(undefined, 'bold');
                pdf.text("DECLARACI√ìN JURADA DE SALUD", 105, 18, { align: "center" });
                pdf.setLineWidth(0.5); pdf.line(15, 25, 195, 25);
            };

            // SECCI√ìN I: 14 CAMPOS LIMPIOS
            drawHeader(doc);
            doc.autoTable({
                startY: 28,
                head: [[{content: 'I. AFILIACI√ìN DEL TRABAJADOR', colSpan: 4, styles: {fillColor: [240, 240, 240], textColor: 0, fontStyle: 'bold' } }]],
                body: [
                    ['1. NOMBRES', d.paciente.nombres.toUpperCase(), '2. APELLIDOS', d.paciente.apellidos.toUpperCase()],
                    ['3. EDAD', String(d.filiacion?.edad || '---'), '4. SEXO', String(d.filiacion?.sexo || '---').toUpperCase()],
                    ['5. C.I.', String(d.paciente.ci || '---'), '6. ESTADO CIVIL', String(d.filiacion?.estado_civil || '---').toUpperCase()],
                    ['7. FECHA NAC.', String(d.filiacion?.fecha_nacimiento || '---'), '8. LUGAR NAC.', String(d.filiacion?.lugar_nacimiento || '---').toUpperCase()],
                    ['9. PROFESI√ìN', String(d.filiacion?.profesion_oficio || '---').toUpperCase(), '10. TEL√âFONO', String(d.filiacion?.telefono || '---')],
                    ['11. DOMICILIO', String(d.filiacion?.domicilio || '---').toUpperCase(), '12. CIUDAD', String(d.filiacion?.ciudad || '---').toUpperCase()],
                    ['13. PA√çS', String(d.filiacion?.pais || '---').toUpperCase(), '14. EMAIL', String(d.paciente.email || 'N/A').toUpperCase()]
                ],
                theme: 'grid', styles: { fontSize: 7 }
            });

            // SECCI√ìN II: SISTEMAS (22 FILAS) CON DETECCI√ìN DE "SI"
            const sistemas = [
                { n: 'VISTA', d: d.antecedentes?.vista }, { n: 'AUDITIVO', d: d.antecedentes?.auditivo },
                { n: 'RESPIRATORIO', d: d.antecedentes?.respiratorio }, { n: 'CARDIO-VASCULARES', d: d.antecedentes?.cardio },
                { n: 'EST√ìMAGO/H√çGADO', d: d.antecedentes?.estomago }, { n: 'SANGRE', d: d.antecedentes?.sangre },
                { n: 'GENITO-URINARIO', d: d.antecedentes?.genito }, { n: 'SISTEMA NERVIOSO', d: d.antecedentes?.nervioso },
                { n: 'PSIQUI√ÅTRICOS', d: d.antecedentes?.psiquiatrico }, { n: 'OSTEOMUSCULARES', d: d.antecedentes?.osteo },
                { n: 'ENDOCRINOL√ìGICOS', d: d.antecedentes?.endocrino }, { n: 'REUMATOL√ìGICOS', d: d.antecedentes?.reumato },
                { n: 'GENERALES', d: d.antecedentes?.generales }, { n: 'DERMATOL√ìGICAS', d: d.antecedentes?.dermato },
                { n: 'ALERGIA', d: d.habitos?.alergias_detalle }, { n: 'INFECCIONES', d: d.antecedentes?.infecciones },
                { n: 'CIRUG√çAS', d: d.antecedentes?.cirugias }, { n: 'ACCIDENTES TRABAJO', d: d.habitos?.accidentes_detalle },
                { n: 'ACCIDENTES PERS.', d: d.antecedentes?.accidentes_p }, { n: 'MEDICAMENTOS', d: d.habitos?.medicamentos_detalle },
                { n: 'GRUPO SANGU√çNEO', d: d.habitos?.grupo_sanguineo }, { n: 'DEPORTES', d: d.habitos?.deportes_detalle }
            ];

            const bodySistemas = sistemas.map(s => {
                const positivo = marcarSi(s.d);
                return [s.n, positivo ? 'X' : '', positivo ? '' : 'X', positivo ? String(s.d).toUpperCase() : 'NORMAL'];
            });

            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 5,
                head: [[{content: 'II. SISTEMA / ANTECEDENTES Y RIESGOS', styles: {fillColor: [240, 240, 240], textColor: 0}}, 'SI', 'NO', 'OBSERVACIONES']],
                body: bodySistemas,
                theme: 'grid', styles: { fontSize: 6.5 }
            });

            // HOJA 2
            doc.addPage();
            drawHeader(doc);

            // SECCI√ìN III y IV: H√ÅBITOS E HISTORIA LABORAL (LIMPIA)
            doc.autoTable({
                startY: 28,
                head: [[{content: 'III. H√ÅBITOS', colSpan: 4, styles: {fillColor: [240, 240, 240], textColor: 0}}]],
                body: [
                    ['ALCOHOL', marcarSi(d.habitos?.alcohol_si_no) ? 'SI' : 'NO', 'TABACO', marcarSi(d.habitos?.fuma_si_no) ? 'SI' : 'NO'],
                    ['DROGAS / PIJCHAR', marcarSi(d.habitos?.pijchar_si_no) ? 'SI' : 'NO', 'OTROS', 'N/A']
                ],
                theme: 'grid', styles: { fontSize: 8 }
            });

            // EXTRACCI√ìN LIMPIA DE HISTORIA LABORAL
            const hl = d.habitos?.historia_laboral || "--- | --- | --- | ---";
            const hPartes = hl.split('|').map(p => p.includes(':') ? p.split(':')[1].trim() : p.trim());

            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 5,
                head: [[{content: 'IV. ANTECEDENTES OCUPACIONALES', colSpan: 4, styles: {fillColor: [240, 240, 240], textColor: 0}}]],
                body: [[
                    `EMPRESA: ${hPartes[1] || '---'}`.toUpperCase(),
                    `CARGO: ${hPartes[2] || '---'}`.toUpperCase(),
                    `TIEMPO: ${hPartes[3] || '---'}`.toUpperCase(),
                    'RIESGOS: SI'
                ]],
                theme: 'grid', styles: { fontSize: 8 }
            });

            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 5,
                head: [[{content: 'V. RIESGOS EXPUESTOS', colSpan: 2, styles: {fillColor: [240, 240, 240], textColor: 0}}]],
                body: [
                    ['QU√çMICOS:', String(d.habitos?.riesgos_vida_laboral || 'NINGUNO').toUpperCase()],
                    ['OBSERVACIONES:', 'DECLARACI√ìN JURADA DE SALUD VER√çDICA.']
                ],
                theme: 'grid', styles: { fontSize: 8 }
            });

            doc.setFontSize(9);
            doc.text(`EMITIDO: ${new Date().toLocaleDateString()}`, 15, doc.lastAutoTable.finalY + 15);
            doc.text("FIRMA TRABAJADOR: ___________________________", 195, doc.lastAutoTable.finalY + 15, { align: "right" });

            window.open(URL.createObjectURL(doc.output('blob')), '_blank');
        }
    </script>
</body>
</html>
