<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HC NUBE | Visor Dinámico 22</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-slate-950 text-slate-200 p-4">
    <div class="max-w-md mx-auto mt-20 text-center">
        <h2 class="text-xl font-bold mb-4 uppercase tracking-tighter">Buscador de Historiales</h2>
        <input type="text" id="codigoBusqueda" placeholder="CÓDIGO PACIENTE" class="w-full p-4 bg-slate-900 border border-slate-700 rounded-xl mb-4 text-center">
        <button onclick="buscarPaciente()" class="bg-blue-600 px-10 py-3 rounded-xl font-bold uppercase text-xs">Buscar Registro</button>
        <div id="resultadoVisor" class="hidden mt-10 p-6 border border-emerald-500/30 rounded-3xl bg-emerald-900/10">
            <p id="resNombre" class="font-bold text-white mb-4"></p>
            <button onclick="generarVistaPrevia()" class="bg-emerald-600 px-6 py-2 rounded-lg text-[10px] font-bold">GENERAR PDF PROFESIONAL</button>
        </div>
    </div>

    <script>
        const API_BASE = 'https://historial-clinico-936s.onrender.com';
        let pacienteIdActual = null;

        async function buscarPaciente() {
            const codigo = document.getElementById('codigoBusqueda').value.trim().toUpperCase();
            const res = await fetch(`${API_BASE}/pacientes/`);
            const pacientes = await res.json();
            const p = pacientes.find(x => x.codigo_paciente.toUpperCase() === codigo);
            if (p) {
                pacienteIdActual = p.id;
                document.getElementById('resNombre').textContent = `${p.nombres} ${p.apellidos}`;
                document.getElementById('resultadoVisor').classList.remove('hidden');
            }
        }

        async function generarVistaPrevia() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const res = await fetch(`${API_BASE}/historial-completo/${pacienteIdActual}`);
            const d = await res.json();

            const drawHeader = (pdf) => {
                pdf.addImage('logo.png', 'PNG', 15, 10, 25, 12);
                pdf.setFontSize(10); pdf.setFont(undefined, 'bold');
                pdf.text("DECLARACIÓN JURADA DE SALUD - HISTORIAL CLÍNICO", 105, 18, { align: "center" });
            };

            drawHeader(doc);

            // TABLA I: FILIACIÓN
            doc.autoTable({
                startY: 25,
                head: [[{content: 'I. DATOS DE FILIACIÓN', colSpan: 4, styles: {fillColor: [50, 50, 50]}}]],
                body: [
                    ['NOMBRES:', `${d.paciente.nombres} ${d.paciente.apellidos}`, 'C.I.:', d.paciente.ci],
                    ['EDAD:', d.filiacion?.edad || '', 'SEXO:', d.filiacion?.sexo || ''],
                    ['PROFESIÓN:', d.filiacion?.profesion_oficio || '', 'TELÉFONO:', d.filiacion?.telefono || '']
                ],
                theme: 'grid', styles: { fontSize: 8 }
            });

            // LÓGICA DINÁMICA PARA LOS 22 CAMPOS
            // Mapeamos los nombres de los campos de tu Base de Datos
            const mapaSistemas = [
                { etiqueta: 'VISTA', sub: 'GLAUCOMA, MIOPÍA', dato: d.antecedentes?.vista },
                { etiqueta: 'AUDITIVO', sub: 'SORDERA, OTITIS', dato: d.antecedentes?.auditivo },
                { etiqueta: 'RESPIRATORIO', sub: 'ASMA, BRONQUITIS', dato: d.antecedentes?.respiratorio },
                { etiqueta: 'CARDIO-VASCULARES', sub: 'HIPERTENSIÓN', dato: d.antecedentes?.cardio },
                { etiqueta: 'ESTÓMAGO/HÍGADO', sub: 'GASTRITIS, HERNIA', dato: d.antecedentes?.estomago },
                { etiqueta: 'SANGRE', sub: 'ANEMIA, CHAGAS', dato: d.antecedentes?.sangre },
                { etiqueta: 'GENITO-URINARIO', sub: 'CÁLCULOS', dato: d.antecedentes?.genito },
                { etiqueta: 'SISTEMA NERVIOSO', sub: 'EPILEPSIA, MIGRAÑA', dato: d.antecedentes?.nervioso },
                { etiqueta: 'PSIQUIÁTRICOS', sub: 'DEPRESIÓN', dato: d.antecedentes?.psiquiatrico },
                { etiqueta: 'OSTEOMUSCULARES', sub: 'ARTRITIS', dato: d.antecedentes?.osteo },
                { etiqueta: 'ENDOCRINOLÓGICOS', sub: 'DIABETES, TIROIDES', dato: d.antecedentes?.endocrino },
                { etiqueta: 'REUMATOLÓGICOS', sub: 'LUPUS', dato: d.antecedentes?.reumato },
                { etiqueta: 'GENERALES', sub: 'OBESIDAD, DESMAYOS', dato: d.antecedentes?.generales },
                { etiqueta: 'DERMATOLÓGICAS', sub: 'MICOSIS, ALERGIAS', dato: d.antecedentes?.dermato },
                { etiqueta: 'ALERGIA', sub: 'RINITIS, URTICARIA', dato: d.habitos?.alergias_detalle },
                { etiqueta: 'INFECCIONES', sub: 'TBC, VIH, SÍFILIS', dato: d.antecedentes?.infecciones },
                { etiqueta: 'CIRUGÍAS', sub: 'CIRUGÍAS PREVIAS', dato: d.antecedentes?.cirugias },
                { etiqueta: 'ACCIDENTES TRABAJO', sub: 'LESIONES LABORALES', dato: d.habitos?.accidentes_detalle },
                { etiqueta: 'ACCIDENTES PERS.', sub: 'LESIONES PARTICULARES', dato: d.antecedentes?.accidentes_p },
                { etiqueta: 'MEDICAMENTOS', sub: 'USO ACTUAL', dato: d.habitos?.medicamentos_detalle },
                { etiqueta: 'GRUPO SANGUÍNEO', sub: 'TIPO DE SANGRE', dato: d.habitos?.grupo_sanguineo },
                { etiqueta: 'DEPORTES', sub: 'ACTIVIDAD FÍSICA', dato: d.habitos?.deportes_detalle }
            ];

            const bodySistemas = mapaSistemas.map(s => {
                // Si el dato existe, no es "N/A", no es "NO" y no está vacío -> Es un "SI"
                const tieneInformacion = s.dato && s.dato !== 'N/A' && s.dato !== 'NO' && s.dato !== '';
                return [
                    { content: `${s.etiqueta}\n${s.sub}`, styles: { fontStyle: 'bold' } },
                    tieneInformacion ? 'X' : '', 
                    tieneInformacion ? '' : 'X', 
                    tieneInformacion ? s.dato.toUpperCase() : 'NORMAL'
                ];
            });

            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 5,
                head: [['II. SISTEMAS / RIESGOS', 'SI', 'NO', 'OBSERVACIONES / DETALLES']],
                body: bodySistemas,
                theme: 'grid',
                styles: { fontSize: 7, cellPadding: 1 },
                headStyles: { fillColor: [0, 150, 100] }
            });

            // SECCIÓN V: RIESGOS LABORALES
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 5,
                head: [[{content: 'V. RIESGOS EN VIDA LABORAL', colSpan: 2}]],
                body: [
                    ['QUÍMICOS:', d.habitos?.riesgos_vida_laboral || 'NINGUNO'],
                    ['OBSERVACIONES:', 'DECLARACIÓN JURADA FINAL.']
                ],
                theme: 'grid', styles: { fontSize: 8 }
            });

            window.open(URL.createObjectURL(doc.output('blob')), '_blank');
        }
    </script>
</body>
</html>
