<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VISOR HISTORIAL CLÍNICO NUBE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-slate-950 text-white p-6">

    <div class="max-w-xl mx-auto space-y-6">
        <div class="bg-slate-900 p-8 rounded-3xl border border-slate-800 shadow-2xl">
            <h2 class="text-center text-xl font-bold mb-6 tracking-widest">BUSCADOR DE HISTORIALES</h2>
            <div class="flex gap-2">
                <input type="text" id="codigoBusqueda" placeholder="CÓDIGO PACIENTE" 
                    class="flex-1 bg-slate-950 border border-slate-700 rounded-xl py-4 px-6 text-center text-blue-400 font-bold uppercase">
                <button onclick="buscarPaciente()" class="bg-blue-600 hover:bg-blue-500 px-8 rounded-xl font-bold transition-all">BUSCAR</button>
            </div>
        </div>

        <div id="resultadoVisor" class="hidden bg-slate-900 p-8 rounded-3xl border border-slate-800 text-center animate-pulse">
            <div class="mb-4">
                <p class="text-xs text-slate-500 uppercase tracking-widest">Paciente Encontrado</p>
                <h3 id="resNombre" class="text-2xl font-black text-white mt-1">---</h3>
                <span id="resCodigo" class="inline-block bg-blue-500/10 text-blue-400 border border-blue-500/20 px-4 py-1 rounded-full text-xs font-bold mt-2">---</span>
            </div>
            <button onclick="generarVistaPrevia()" class="w-full bg-emerald-600 hover:bg-emerald-500 py-4 rounded-xl font-black uppercase tracking-tighter transition-all">
                GENERAR PDF PROFESIONAL
            </button>
        </div>
    </div>

    <script>
        const API_BASE = 'https://historial-clinico-936s.onrender.com';
        let datosPacienteActual = null; // Variable única de control

        // 1. LIMPIEZA TOTAL AL BUSCAR
        async function buscarPaciente() {
            // Reset de seguridad
            datosPacienteActual = null;
            document.getElementById('resultadoVisor').classList.add('hidden');
            
            const codigo = document.getElementById('codigoBusqueda').value.trim().toUpperCase();
            if (!codigo) return;

            try {
                const response = await fetch(`${API_BASE}/pacientes/`);
                const pacientes = await response.json();
                const p = pacientes.find(x => x.codigo_paciente.toUpperCase() === codigo);
                
                if (p) {
                    const resFull = await fetch(`${API_BASE}/historial-completo/${p.id}`);
                    datosPacienteActual = await resFull.json();
                    
                    document.getElementById('resNombre').textContent = `${datosPacienteActual.paciente.nombres} ${datosPacienteActual.paciente.apellidos}`.toUpperCase();
                    document.getElementById('resCodigo').textContent = datosPacienteActual.paciente.codigo_paciente.toUpperCase();
                    document.getElementById('resultadoVisor').classList.remove('hidden');
                } else {
                    alert("Paciente no encontrado");
                }
            } catch (e) { alert("Error de conexión con el servidor"); }
        }

        async function generarVistaPrevia() {
            if (!datosPacienteActual) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const d = datosPacienteActual; // Alias para el registro actual

            // DETECCIÓN DE "SI" REFORZADA: Solo si el texto es distinto a los negativos conocidos
            const checkSi = (val) => {
                if (!val) return false;
                const v = String(val).trim().toUpperCase();
                const negativos = ["NO", "N/A", "NORMAL", "NINGUNO", "SIN RIESGOS", "---", "NORMAL.", ""];
                return !negativos.includes(v);
            };

            const drawHeader = (pdf) => {
                pdf.setFontSize(14); pdf.setFont(undefined, 'bold');
                pdf.text("DECLARACIÓN JURADA DE SALUD - HISTORIAL CLÍNICO", 105, 18, { align: "center" });
                pdf.setLineWidth(0.5); pdf.line(15, 22, 195, 22);
            };

            // HOJA 1: FILIACIÓN (14 CAMPOS)
            drawHeader(doc);
            doc.autoTable({
                startY: 25,
                head: [[{content: 'I. DATOS DE FILIACIÓN', colSpan: 4, styles: {fillColor: [50, 50, 50]}}]],
                body: [
                    ['NOMBRES:', d.paciente.nombres.toUpperCase(), 'C.I.:', String(d.paciente.ci || '---')],
                    ['EDAD:', String(d.filiacion?.edad || '---'), 'SEXO:', String(d.filiacion?.sexo || '---').toUpperCase()],
                    ['PROFESIÓN:', String(d.filiacion?.profesion_oficio || '---').toUpperCase(), 'TELÉFONO:', String(d.filiacion?.telefono || '---')],
                    ['FECHA NAC:', String(d.filiacion?.fecha_nacimiento || '---'), 'LUGAR NAC:', String(d.filiacion?.lugar_nacimiento || '---').toUpperCase()],
                    ['DOMICILIO:', String(d.filiacion?.domicilio || '---').toUpperCase(), 'CIUDAD:', String(d.filiacion?.ciudad || '---').toUpperCase()],
                    ['PAÍS:', String(d.filiacion?.pais || '---').toUpperCase(), 'EMAIL:', String(d.paciente.email || 'N/A').toUpperCase()]
                ],
                theme: 'grid', styles: { fontSize: 7.5 }
            });

            // II. SISTEMAS (22 CAMPOS CON DETECCIÓN SI/NO)
            const mapSist = [
                { n: 'VISTA', v: d.antecedentes?.vista }, { n: 'AUDITIVO', v: d.antecedentes?.auditivo },
                { n: 'RESPIRATORIO', v: d.antecedentes?.respiratorio }, { n: 'CARDIO-VASCULARES', v: d.antecedentes?.cardio },
                { n: 'ESTÓMAGO/HÍGADO', v: d.antecedentes?.estomago }, { n: 'SANGRE', v: d.antecedentes?.sangre },
                { n: 'GENITO-URINARIO', v: d.antecedentes?.genito }, { n: 'SISTEMA NERVIOSO', v: d.antecedentes?.nervioso },
                { n: 'PSIQUIÁTRICOS', v: d.antecedentes?.psiquiatrico }, { n: 'OSTEOMUSCULARES', v: d.antecedentes?.osteo },
                { n: 'ENDOCRINOLÓGICOS', v: d.antecedentes?.endocrino }, { n: 'REUMATOLÓGICOS', v: d.antecedentes?.reumato },
                { n: 'GENERALES', v: d.antecedentes?.generales }, { n: 'DERMATOLÓGICAS', v: d.antecedentes?.dermato },
                { n: 'ALERGIA', v: d.habitos?.alergias_detalle }, { n: 'INFECCIONES', v: d.antecedentes?.infecciones },
                { n: 'CIRUGÍAS', v: d.antecedentes?.cirugias }, { n: 'ACCIDENTES TRABAJO', v: d.habitos?.accidentes_detalle },
                { n: 'ACCIDENTES PERS.', v: d.antecedentes?.accidentes_p }, { n: 'MEDICAMENTOS', v: d.habitos?.medicamentos_detalle },
                { n: 'GRUPO SANGUÍNEO', v: d.habitos?.grupo_sanguineo }, { n: 'DEPORTES', v: d.habitos?.deportes_detalle }
            ];

            const bodySist = mapSist.map(s => {
                const esSi = checkSi(s.v);
                return [s.n, esSi ? 'X' : '', esSi ? '' : 'X', esSi ? String(s.v).toUpperCase() : 'NORMAL'];
            });

            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 5,
                head: [[{content: 'II. SISTEMAS / RIESGOS', styles: {fillColor: [0, 168, 120]}}, 'SI', 'NO', 'OBSERVACIONES / DETALLES']],
                body: bodySist,
                theme: 'grid', styles: { fontSize: 6.5 }
            });

            // III. HISTORIA LABORAL (LIMPIEZA DE PIPE '|')
            const hl = d.habitos?.historia_laboral || "";
            let p1 = '---', p2 = '---', p3 = '---', p4 = '---';
            if(hl.includes('|')) {
                const partes = hl.split('|');
                p1 = partes[0]?.split(':')[1]?.trim() || '---';
                p2 = partes[1]?.split(':')[1]?.trim() || '---';
                p3 = partes[2]?.split(':')[1]?.trim() || '---';
                p4 = partes[3]?.split(':')[1]?.trim() || '---';
            }

            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 5,
                head: [[{content: 'IV. ANTECEDENTES OCUPACIONALES', colSpan: 4, styles: {fillColor: [50, 50, 50]}}]],
                body: [['EMPRESA:', p2.toUpperCase(), 'CARGO:', p3.toUpperCase()], ['TIEMPO:', p4.toUpperCase(), 'RIESGOS:', 'SI']],
                theme: 'grid', styles: { fontSize: 8 }
            });

            // IV. RIESGOS EXPUESTOS
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 5,
                head: [[{content: 'V. RIESGOS EN VIDA LABORAL', colSpan: 2, styles: {fillColor: [0, 168, 120]}}]],
                body: [
                    ['QUÍMICOS:', String(d.habitos?.riesgos_vida_laboral || 'NINGUNO').toUpperCase()],
                    ['OBSERVACIONES:', 'DECLARACIÓN JURADA FINAL.']
                ],
                theme: 'grid', styles: { fontSize: 8 }
            });

            doc.setFontSize(8);
            doc.text(`FECHA EMISIÓN: ${new Date().toLocaleDateString()}`, 15, doc.lastAutoTable.finalY + 10);
            doc.text("FIRMA TRABAJADOR: ___________________________", 195, doc.lastAutoTable.finalY + 10, { align: "right" });

            window.open(URL.createObjectURL(doc.output('blob')), '_blank');
        }
    </script>
</body>
</html>
