<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VISOR HISTORIAL CL√çNICO NUBE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-[#050a15] text-white p-6 font-sans">

    <div class="max-w-xl mx-auto space-y-4">
        <div class="bg-[#0f172a] p-8 rounded-2xl border border-slate-800 shadow-2xl text-center">
            <h2 class="text-xl font-black mb-6 tracking-tighter italic uppercase">Buscador de Historiales</h2>
            <div class="flex gap-2">
                <input type="text" id="codigoBusqueda" placeholder="C√ìDIGO (Ej: RA3372)" 
                    class="flex-1 bg-slate-900 border border-slate-700 rounded-xl py-4 px-6 text-center text-blue-400 font-bold uppercase focus:border-blue-500 outline-none">
                <button onclick="buscarPaciente()" class="bg-blue-600 hover:bg-blue-500 px-8 rounded-xl font-bold transition-all">BUSCAR</button>
            </div>
        </div>

        <div id="resultadoVisor" class="hidden bg-[#0f172a] p-8 rounded-2xl border border-emerald-900/30 text-center">
            <div class="mb-6">
                <div class="w-16 h-16 bg-emerald-500/10 rounded-full flex items-center justify-center mx-auto mb-4 text-emerald-500 text-2xl">üë§</div>
                <h3 id="resNombre" class="text-2xl font-black text-white uppercase tracking-tight">---</h3>
                <p id="resCodigo" class="text-blue-400 font-bold text-sm tracking-widest mt-1">---</p>
            </div>
            <button onclick="generarVistaPrevia()" class="w-full bg-emerald-600 hover:bg-emerald-500 py-4 rounded-xl font-black uppercase tracking-widest transition-all shadow-lg shadow-emerald-900/20">
                GENERAR PDF PROFESIONAL
            </button>
        </div>
    </div>

    <script>
        const API_BASE = 'https://historial-clinico-936s.onrender.com';
        let d = null; // Purga inicial de buffer

        async function buscarPaciente() {
            // LIMPIEZA TOTAL ANTES DE EMPEZAR
            d = null; 
            document.getElementById('resultadoVisor').classList.add('hidden');
            
            const codigo = document.getElementById('codigoBusqueda').value.trim().toUpperCase();
            if (!codigo) return;

            try {
                const response = await fetch(`${API_BASE}/pacientes/`);
                const pacientes = await response.json();
                const p = pacientes.find(x => x.codigo_paciente.toUpperCase() === codigo);
                
                if (p) {
                    const resFull = await fetch(`${API_BASE}/historial-completo/${p.id}`);
                    d = await resFull.json(); // Carga de datos nuevos
                    
                    document.getElementById('resNombre').textContent = `${d.paciente.nombres} ${d.paciente.apellidos}`.toUpperCase();
                    document.getElementById('resCodigo').textContent = d.paciente.codigo_paciente.toUpperCase();
                    document.getElementById('resultadoVisor').classList.remove('hidden');
                } else {
                    alert("PACIENTE NO REGISTRADO");
                }
            } catch (e) { alert("ERROR DE CONEXI√ìN CON EL SERVIDOR"); }
        }

        async function generarVistaPrevia() {
            if (!d) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');

            // L√ìGICA DE DETECCI√ìN "SI": Ignora expl√≠citamente los valores negativos o vac√≠os
            const esPositivo = (valor) => {
                if (!valor) return false;
                const v = String(valor).trim().toUpperCase();
                const negativos = ["NO", "NORMAL", "N/A", "NINGUNO", "SIN RIESGOS", "---", "NORMAL.", ""];
                return !negativos.includes(v);
            };

            // SECCI√ìN I: AFILIACI√ìN (Sin n√∫meros, estructura limpia)
            doc.setFontSize(14); doc.setFont(undefined, 'bold');
            doc.text("DECLARACION JURADA DE SALUD", 105, 15, { align: "center" });
            doc.setLineWidth(0.4); doc.line(15, 20, 195, 20);

            doc.autoTable({
                startY: 23,
                head: [[{content: 'I. AFILIACION DEL TRABAJADOR', colSpan: 4, styles: {fillColor: [240, 240, 240], textColor: 0}}]],
                body: [
                    ['APELLIDOS Y NOMBRES', `${d.paciente.apellidos} ${d.paciente.nombres}`.toUpperCase(), '', ''],
                    ['EDAD', String(d.filiacion?.edad || '---'), 'SEXO', String(d.filiacion?.sexo || '---').toUpperCase()],
                    ['FECHA NACIMIENTO', String(d.filiacion?.fecha_nacimiento || '---'), 'LUGAR', String(d.filiacion?.lugar_nacimiento || '---').toUpperCase()],
                    ['C.I.', String(d.paciente.ci || '---'), 'ESTADO CIVIL', String(d.filiacion?.estado_civil || '---').toUpperCase()],
                    ['DOMICILIO', String(d.filiacion?.domicilio || '---').toUpperCase(), 'CIUDAD / PA√çS', `${d.filiacion?.ciudad || '---'} / ${d.filiacion?.pais || '---'}`.toUpperCase()],
                    ['TEL√âFONO', String(d.filiacion?.telefono || '---'), 'PROFESI√ìN / LABOR', String(d.filiacion?.profesion_oficio || '---').toUpperCase()]
                ],
                theme: 'grid', styles: { fontSize: 7.5, cellPadding: 1.5 }
            });

            // SECCI√ìN II: SISTEMAS (22 FILAS)
            const sistemas = [
                { n: 'VISTA', v: d.antecedentes?.vista }, { n: 'AUDITIVO', v: d.antecedentes?.auditivo },
                { n: 'RESPIRATORIO', v: d.antecedentes?.respiratorio }, { n: 'CARDIO-VASCULARES', v: d.antecedentes?.cardio },
                { n: 'EST√ìMAGO/H√çGADO', v: d.antecedentes?.estomago }, { n: 'SANGRE', v: d.antecedentes?.sangre },
                { n: 'GENITO-URINARIO', v: d.antecedentes?.genito }, { n: 'SISTEMA NERVIOSO', v: d.antecedentes?.nervioso },
                { n: 'PSIQUI√ÅTRICOS', v: d.antecedentes?.psiquiatrico }, { n: 'OSTEOMUSCULARES', v: d.antecedentes?.osteo },
                { n: 'ENDOCRINOL√ìGICOS', v: d.antecedentes?.endocrino }, { n: 'REUMATOL√ìGICOS', v: d.antecedentes?.reumato },
                { n: 'GENERALES', v: d.antecedentes?.generales }, { n: 'DERMATOL√ìGICAS', v: d.antecedentes?.dermato },
                { n: 'ALERGIA', v: d.habitos?.alergias_detalle }, { n: 'INFECCIONES', v: d.antecedentes?.infecciones },
                { n: 'CIRUG√çAS', v: d.antecedentes?.cirugias }, { n: 'ACCIDENTES DE TRABAJO', v: d.habitos?.accidentes_detalle },
                { n: 'ACCIDENTES PERS.', v: d.antecedentes?.accidentes_p }, { n: 'MEDICAMENTOS', v: d.habitos?.medicamentos_detalle },
                { n: 'GRUPO SANGU√çNEO', v: d.habitos?.grupo_sanguineo }, { n: 'DEPORTES', v: d.habitos?.deportes_detalle }
            ];

            const bodySist = sistemas.map(s => {
                const pos = esPositivo(s.v);
                return [s.n, pos ? 'X' : '', pos ? '' : 'X', pos ? String(s.v).toUpperCase() : 'NORMAL'];
            });

            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 4,
                head: [[{content: 'II. SISTEMA / ANTECEDENTES Y RIESGOS', styles: {fillColor: [0, 180, 140]}}, 'SI', 'NO', 'OBSERVACIONES / DETALLES']],
                body: bodySist,
                theme: 'grid', styles: { fontSize: 6.5, cellPadding: 1 }
            });

            // HOJA 2
            doc.addPage();
            doc.text("DECLARACION JURADA DE SALUD", 105, 15, { align: "center" });

            // SECCI√ìN III: H√ÅBITOS
            doc.autoTable({
                startY: 23,
                head: [[{content: 'III. H√ÅBITOS Y VIDA PERSONAL', colSpan: 4, styles: {fillColor: [240, 240, 240], textColor: 0}}]],
                body: [
                    ['ALCOHOL', String(d.habitos?.alcohol_si_no || 'NO').toUpperCase(), 'TABACO', String(d.habitos?.fuma_si_no || 'NO').toUpperCase()],
                    ['DROGAS / PIJCHAR', String(d.habitos?.pijchar_si_no || 'NO').toUpperCase(), 'OTROS', 'N/A']
                ],
                theme: 'grid', styles: { fontSize: 8 }
            });

            // SECCI√ìN IV: HISTORIA LABORAL (Extracci√≥n segura sin repetir "Senado")
            const hl = d.habitos?.historia_laboral || "";
            let emp = '---', carg = '---', tiemp = '---';
            if(hl.includes('|')) {
                const parts = hl.split('|');
                emp = parts[1]?.split(':')[1]?.trim() || '---';
                carg = parts[2]?.split(':')[1]?.trim() || '---';
                tiemp = parts[3]?.split(':')[1]?.trim() || '---';
            }

            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 5,
                head: [[{content: 'IV. ANTECEDENTES OCUPACIONALES (HISTORIA LABORAL)', colSpan: 4, styles: {fillColor: [240, 240, 240], textColor: 0}}]],
                body: [['EMPRESA', emp.toUpperCase(), 'CARGO', carg.toUpperCase()], ['TIEMPO', tiemp.toUpperCase(), 'RIESGOS', 'SI']],
                theme: 'grid', styles: { fontSize: 8 }
            });

            // SECCI√ìN V: RIESGOS EXPUESTOS
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 5,
                head: [[{content: 'V. ANTECEDENTES DE RIESGOS EXPUESTOS DURANTE LA VIDA LABORAL', colSpan: 2, styles: {fillColor: [240, 240, 240], textColor: 0}}]],
                body: [
                    ['QU√çMICOS:', String(d.habitos?.riesgos_vida_laboral || 'NINGUNO').toUpperCase()],
                    ['OBSERVACIONES:', 'DECLARO QUE LA INFORMACI√ìN PROPORCIONADA ES VER√çDICA Y ACTUALIZADA.']
                ],
                theme: 'grid', styles: { fontSize: 8 }
            });

            doc.setFontSize(9);
            doc.text(`FECHA DE EMISI√ìN: ${new Date().toLocaleDateString()}`, 15, doc.lastAutoTable.finalY + 15);
            doc.text("FIRMA DEL TRABAJADOR: ___________________________", 195, doc.lastAutoTable.finalY + 15, { align: "right" });

            window.open(URL.createObjectURL(doc.output('blob')), '_blank');
        }
    </script>
</body>
</html>
