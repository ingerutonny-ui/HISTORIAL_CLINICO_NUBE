import os
import json
import requests
import traceback
from flask import Flask, request, jsonify
from flask_cors import CORS
from vercel_blob import put, list_blobs

app = Flask(__name__)
CORS(app)

BLOB_FILENAME = "pacientes_datos.json"

@app.route('/api/pacientes', methods=['GET'])
def get_pacientes():
    try:
        all_blobs = list_blobs()
        target = next((b for b in all_blobs['blobs'] if b['pathname'] == BLOB_FILENAME), None)
        if target:
            r = requests.get(target['url'])
            return jsonify(r.json()), 200
        return jsonify([]), 200
    except Exception as e:
        return jsonify({"error": str(e)}), 500

@app.route('/api/pacientes', methods=['POST'])
def add_paciente():
    try:
        data = request.json
        if not data:
            return jsonify({"error": "No se recibieron datos"}), 400

        # Intentar conectar con el Blob
        try:
            all_blobs = list_blobs()
        except Exception as e:
            return jsonify({"error": f"Error de autenticación Blob: {str(e)}"}), 500

        target = next((b for b in all_blobs['blobs'] if b['pathname'] == BLOB_FILENAME), None)
        
        lista_actual = []
        if target:
            r = requests.get(target['url'])
            lista_actual = r.json()

        nuevo_paciente = {
            "id": len(lista_actual) + 1,
            "nombre": data.get('nombre'),
            "apellido": data.get('apellido'),
            "dni": data.get('dni')
        }
        lista_actual.append(nuevo_paciente)

        # Guardar en la nube
        put(BLOB_FILENAME, json.dumps(lista_actual), {
            "contentType": "application/json",
            "addRandomSuffix": "false"
        })
        
        return jsonify({"mensaje": "Registrado exitosamente"}), 201
    except Exception:
        # Esto nos dirá el error real en la consola de Vercel
        error_detallado = traceback.format_exc()
        print(error_detallado)
        return jsonify({"error": "Fallo interno", "detalle": error_detallado}), 500

if __name__ == '__main__':
    app.run()
