<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>HC NUBE | P2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; font-size: 13px; }
        .container-main { background: white; padding: 20px; border-radius: 15px; max-width: 1000px; margin: 20px auto; border: 1px solid #eee; }
        .header-box { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #27ae60; padding-bottom: 10px; }
        .grid-items { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .item-row { background: #fff; padding: 8px; border-radius: 8px; border: 1px solid #ddd; display: flex; align-items: center; gap: 8px; }
        .label-text { flex: 1; color: #444; text-transform: uppercase; font-size: 11px; }
        .sel-mini { width: 60px; border: 1px solid #27ae60; border-radius: 4px; font-size: 11px; }
        .inp-mini { flex: 1.5; border: 1px solid #ccc; border-radius: 4px; padding: 2px 5px; font-size: 11px; text-transform: uppercase; }
        .btn-save { background: #27ae60; color: white; border: none; width: 100%; padding: 12px; border-radius: 8px; margin-top: 15px; text-transform: uppercase; }
    </style>
</head>
<body>
<div class="container-main">
    <div class="header-box">
        <img src="https://ingerutonny-ui.github.io/HISTORIAL_CLINICO_NUBE/logo.png" height="40">
        <span>2. ANTECEDENTES PATOLÓGICOS (PARTE 2 / 3)</span>
    </div>
    <form id="formP2">
        <div id="grid" class="grid-items"></div>
        <button type="submit" id="btn" class="btn-save">Guardar y Continuar</button>
    </form>
</div>

<script>
    const API = 'https://historial-clinico-936s.onrender.com';
    const campos = [
        {id:"vista", n:"1. VISTA"}, {id:"auditivo", n:"2. AUDITIVO"}, {id:"respiratorio", n:"3. RESPIRATORIO"},
        {id:"cardio", n:"4. CARDIOVASCULARES"}, {id:"digestivos", n:"5. DIGESTIVOS"}, {id:"sangre", n:"6. SANGRE"},
        {id:"genitourinario", n:"7. GENITOURINARIO"}, {id:"sistema_nervioso", n:"8. SISTEMA NERVIOSO"},
        {id:"psiquiatricos", n:"9. PSIQUIÁTRICOS"}, {id:"osteomusculares", n:"10. OSTEOMUSCULARES"},
        {id:"endocrino", n:"11. ENDOCRINO"}, {id:"alergias", n:"12. ALERGIAS"}, {id:"cirugias", n:"13. CIRUGÍAS"},
        {id:"acc_trabajo", n:"14. ACCIDENTES TRABAJO"}, {id:"acc_personales", n:"15. ACCIDENTES PERS."},
        {id:"medicamentos", n:"16. MEDICAMENTOS"}, {id:"infecciosas", n:"17. INFECCIOSAS"},
        {id:"ap_urinario", n:"18. AP. URINARIO"}, {id:"linfatico", n:"19. LINFÁTICO"},
        {id:"reumatologicos", n:"20. REUMATOLÓGICOS"}, {id:"otros", n:"21. OTROS"}, {id:"generales", n:"22. GENERALES"}
    ];

    document.getElementById('grid').innerHTML = campos.map(c => `
        <div class="item-row">
            <span class="label-text">${c.n}</span>
            <select class="sel-mini" id="s_${c.id}"><option value="NO">NO</option><option value="SI">SI</option></select>
            <input type="text" class="inp-mini" id="d_${c.id}" value="NORMAL">
        </div>`).join('');

    document.getElementById('formP2').onsubmit = async (e) => {
        e.preventDefault();
        const b = document.getElementById('btn');
        b.disabled = true; b.innerText = "Enviando...";

        const data = { paciente_id: parseInt(localStorage.getItem('paciente_id')) };
        campos.forEach(c => {
            const s = document.getElementById(`s_${c.id}`).value;
            const d = document.getElementById(`d_${c.id}`).value.toUpperCase();
            data[c.id] = (s === 'SI') ? d : "NORMAL";
        });

        try {
            const res = await fetch(`${API}/declaraciones/p2/`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if (res.ok) window.location.href = "declaracion_jurada_p3.html";
            else alert("Error 422/500: Revisa schemas.py en el Backend");
        } catch (err) { alert("Error de conexión"); }
        finally { b.disabled = false; b.innerText = "Guardar y Continuar"; }
    };
</script>
</body>
</html>
