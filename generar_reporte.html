<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>REPORTE OFICIAL - HISTORIAL CLÍNICO NUBE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #525659; padding: 20px; font-family: 'Arial', sans-serif; }
        #hoja { width: 190mm; min-height: 275mm; padding: 15mm; margin: auto; background: white; box-shadow: 0 0 15px rgba(0,0,0,0.5); }
        .tabla { width: 100%; border: 1.2px solid black; border-collapse: collapse; margin-bottom: 10px; }
        .tabla td { border: 1px solid black; padding: 5px; font-size: 8.5pt; }
        .titulo { background: #e9ecef; font-weight: bold; text-align: center; text-transform: uppercase; }
        .lb { font-weight: bold; background: #f2f2f2; width: 22%; }
        .vl { font-weight: bold; color: #000; text-transform: uppercase; padding-left: 8px; }
        @media print { .no-print { display: none; } #hoja { box-shadow: none; margin: 0; } }
    </style>
</head>
<body>

<div class="text-center no-print mb-3">
    <button onclick="window.history.back()" class="btn btn-dark">VOLVER AL VISOR</button>
    <button onclick="descargar()" class="btn btn-success fw-bold">DESCARGAR REPORTE PDF</button>
</div>

<div id="hoja">
    <h5 class="text-center fw-bold mb-4">DECLARACIÓN JURADA DE SALUD</h5>

    <table class="tabla">
        <tr><td colspan="4" class="titulo">I. DATOS DE AFILIACIÓN (P1)</td></tr>
        <tr><td class="lb">PACIENTE:</td><td class="vl" id="d_nombre" colspan="3"></td></tr>
        <tr>
            <td class="lb">C.I.:</td><td class="vl" id="d_ci"></td>
            <td class="lb">EDAD:</td><td class="vl" id="d_edad"></td>
        </tr>
        <tr>
            <td class="lb">EMPRESA:</td><td class="vl" id="d_empresa"></td>
            <td class="lb">OCUPACIÓN:</td><td class="vl" id="d_ocup"></td>
        </tr>
        <tr>
            <td class="lb">TELÉFONO:</td><td class="vl" id="d_telf"></td>
            <td class="lb">EMAIL:</td><td class="vl" id="d_email"></td>
        </tr>
    </table>

    <table class="tabla">
        <tr><td colspan="4" class="titulo">II. ANTECEDENTES PATOLÓGICOS (P2)</td></tr>
        <tbody id="grid_p2"></tbody>
    </table>

    <table class="tabla">
        <tr><td colspan="2" class="titulo">III. HÁBITOS Y RIESGOS (P3)</td></tr>
        <tbody id="grid_p3"></tbody>
    </table>

    <div style="margin-top: 50px; display: flex; justify-content: space-around; text-align: center; font-size: 9pt;">
        <div>__________________________<br>FIRMA DEL PACIENTE<br><b id="f_nombre"></b></div>
        <div>__________________________<br>MÉDICO EVALUADOR</div>
    </div>
</div>

<script>
    const API = 'https://historial-clinico-936s.onrender.com';
    const p_id = localStorage.getItem('p_id');

    async function cargar() {
        try {
            const r = await fetch(`${API}/pacientes/${p_id}`);
            const p = await r.json();

            if(p && !p.detail) {
                // LLENADO P1
                document.getElementById('d_nombre').innerText = `${p.apellido} ${p.nombre}`;
                document.getElementById('f_nombre').innerText = `${p.apellido} ${p.nombre}`;
                document.getElementById('d_ci').innerText = p.ci || '---';
                document.getElementById('d_edad').innerText = p.edad || '---';
                document.getElementById('d_empresa').innerText = p.empresa || '---';
                document.getElementById('d_ocup').innerText = p.ocupacion || '---';
                document.getElementById('d_telf').innerText = p.telefono || '---';
                document.getElementById('d_email').innerText = p.email || '---';

                // LLENADO P2 (TODOS LOS CAMPOS)
                const camposP2 = [
                    ['ALERGIAS', p.alergias], ['CIRUGIAS', p.cirugias], ['DIABETES', p.diabetes], ['HIPERTENSION', p.hipertension],
                    ['ASMA', p.asma], ['EPILEPSIA', p.epilepsia], ['GASTRITIS', p.gastritis], ['CORAZON', p.corazon],
                    ['RIÑONES', p.rinones], ['VARICES', p.varices], ['TBC', p.tbc], ['CHAGAS', p.chagas],
                    ['TRAUMATISMOS', p.traumatismos], ['HOSPITALIZACIONES', p.hospitalizaciones], ['MEDICAMENTOS', p.medicamentos], ['VACUNAS', p.vacunas],
                    ['ENF. INFANCIA', p.enf_infancia], ['VISION', p.vision], ['AUDICION', p.audicion], ['F. RESPIRATORIA', p.f_respiratoria]
                ];
                let h2 = "";
                for(let i=0; i<camposP2.length; i+=2) {
                    h2 += `<tr><td class="lb">${camposP2[i][0]}:</td><td class="vl">${camposP2[i][1] || 'NO'}</td><td class="lb">${camposP2[i+1][0]}:</td><td class="vl">${camposP2[i+1][1] || 'NO'}</td></tr>`;
                }
                h2 += `<tr><td class="lb">PRESIÓN ART.</td><td class="vl">${p.presion_valor || '---'}</td><td class="lb">OBSERVACIONES</td><td class="vl">${p.observaciones_p2 || 'NINGUNA'}</td></tr>`;
                document.getElementById('grid_p2').innerHTML = h2;

                // LLENADO P3
                const camposP3 = [['¿FUMA?', p.fuma], ['¿ALCOHOL?', p.alcohol], ['¿DROGAS?', p.drogas], ['¿DEPORTES?', p.deportes], ['GRUPO SANGUINEO', p.grupo_sanguineo]];
                document.getElementById('grid_p3').innerHTML = camposP3.map(c => `<tr><td class="lb">${c[0]}</td><td class="vl">${c[1] || '---'}</td></tr>`).join('');
            }
        } catch (e) { console.error(e); }
    }

    function descargar() {
        const el = document.getElementById('hoja');
        html2pdf().set({ margin: 10, filename: 'Reporte_Final.pdf', html2canvas: { scale: 3 }, jsPDF: { format: 'a4' } }).from(el).save();
    }
    window.onload = cargar;
</script>
</body>
</html>
