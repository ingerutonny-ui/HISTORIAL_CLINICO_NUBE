<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>REPORTE MÉDICO OFICIAL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #525659; padding: 30px; }
        #hoja { width: 190mm; min-height: 275mm; padding: 15mm; margin: auto; background: white; }
        .tabla { width: 100%; border: 1px solid black; border-collapse: collapse; margin-bottom: 15px; }
        .tabla td { border: 1px solid black; padding: 6px; font-size: 9pt; }
        .titulo { background: #e9ecef; font-weight: bold; text-align: center; text-transform: uppercase; }
        .label { font-weight: bold; background: #f8f9fa; width: 25%; }
        .valor { font-weight: bold; text-transform: uppercase; padding-left: 10px; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body>

<div class="text-center no-print mb-4">
    <button onclick="window.history.back()" class="btn btn-danger">VOLVER</button>
    <button onclick="descargarPDF()" class="btn btn-success fw-bold">DESCARGAR REPORTE PDF</button>
</div>

<div id="hoja">
    <h4 class="text-center fw-bold text-decoration-underline mb-4">DECLARACIÓN JURADA DE SALUD</h4>

    <table class="tabla">
        <tr><td colspan="4" class="titulo">I. AFILIACIÓN (P1)</td></tr>
        <tr><td class="label">PACIENTE:</td><td class="valor" id="p1_nombre" colspan="3"></td></tr>
        <tr>
            <td class="label">C.I.:</td><td class="valor" id="p1_ci"></td>
            <td class="label">EDAD:</td><td class="valor" id="p1_edad"></td>
        </tr>
        <tr>
            <td class="label">EMPRESA:</td><td class="valor" id="p1_empresa"></td>
            <td class="label">OCUPACIÓN:</td><td class="valor" id="p1_ocupacion"></td>
        </tr>
    </table>

    <table class="tabla">
        <tr><td colspan="4" class="titulo">II. ANTECEDENTES (P2)</td></tr>
        <tbody id="p2_body"></tbody>
    </table>

    <table class="tabla">
        <tr><td colspan="2" class="titulo">III. HÁBITOS (P3)</td></tr>
        <tbody id="p3_body"></tbody>
    </table>

    <div style="margin-top: 60px; display: flex; justify-content: space-around; text-align: center;">
        <div>__________________________<br>FIRMA DEL TRABAJADOR<br><b id="f_nombre"></b></div>
        <div>__________________________<br>MÉDICO EVALUADOR</div>
    </div>
</div>

<script>
    const API = 'https://historial-clinico-936s.onrender.com';
    const p_id = localStorage.getItem('p_id');

    async function cargar() {
        try {
            const res = await fetch(`${API}/pacientes/${p_id}`);
            const p = await res.json();

            if (p && !p.detail) {
                // P1
                document.getElementById('p1_nombre').innerText = `${p.apellido} ${p.nombre}`;
                document.getElementById('f_nombre').innerText = `${p.apellido} ${p.nombre}`;
                document.getElementById('p1_ci').innerText = p.ci || '---';
                document.getElementById('p1_edad').innerText = p.edad || '---';
                document.getElementById('p1_empresa').innerText = p.empresa || '---';
                document.getElementById('p1_ocupacion').innerText = p.ocupacion || '---';

                // P2 - Mapeo completo
                const camposP2 = [
                    ['ALERGIAS', p.alergias], ['CIRUGIAS', p.cirugias], ['DIABETES', p.diabetes], ['HIPERTENSION', p.hipertension],
                    ['ASMA', p.asma], ['EPILEPSIA', p.epilepsia], ['GASTRITIS', p.gastritis], ['CORAZON', p.corazon]
                ];
                let h2 = "";
                for(let i=0; i<camposP2.length; i+=2){
                    h2 += `<tr><td class="label">${camposP2[i][0]}:</td><td class="valor">${camposP2[i][1] || 'NO'}</td><td class="label">${camposP2[i+1][0]}:</td><td class="valor">${camposP2[i+1][1] || 'NO'}</td></tr>`;
                }
                document.getElementById('p2_body').innerHTML = h2;

                // P3
                const camposP3 = [['FUMA', p.fuma], ['ALCOHOL', p.alcohol], ['DROGAS', p.drogas], ['DEPORTES', p.deportes]];
                document.getElementById('p3_body').innerHTML = camposP3.map(c => `<tr><td class="label">${c[0]}:</td><td class="valor">${c[1] || '---'}</td></tr>`).join('');
            }
        } catch (e) { console.error(e); }
    }

    function descargarPDF() {
        const element = document.getElementById('hoja');
        html2pdf().from(element).save('Declaracion_Jurada.pdf');
    }
    window.onload = cargar;
</script>
</body>
</html>
