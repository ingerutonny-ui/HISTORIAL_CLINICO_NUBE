<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA MÉDICO | DECLARACIÓN JURADA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f7f6; }
        #hoja-pdf { width: 210mm; padding: 10mm; margin: auto; background: white; }
        
        /* Estilo de Tabla Oficial (Calco de image_c62396.png) */
        .tabla-oficial { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .tabla-oficial th, .tabla-oficial td { border: 2px solid #000; padding: 4px 8px; font-size: 10pt; }
        .bg-gris { background-color: #d9e1f2; font-weight: bold; text-transform: uppercase; }
        
        .header-dj { text-align: center; font-weight: bold; font-size: 14pt; margin-bottom: 20px; text-decoration: underline; }
        .label-sm { font-size: 8pt; font-weight: bold; color: #333; display: block; }
        .dato-v { font-size: 10pt; font-weight: normal; color: #000; min-height: 15px; display: block; }

        .firma-container { margin-top: 40px; }
        .linea { border-top: 1px solid #000; width: 200px; margin: 60px auto 5px; }
        #loader { text-align: center; padding: 50px; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner-border text-primary"></div>
    <h4 class="mt-3">Sincronizando con Base de Datos Nube...</h4>
</div>

<div id="hoja-pdf" style="display: none;">
    <table class="tabla-oficial">
        <tr>
            <td colspan="10" class="bg-gris">AFILIACION DEL TRABAJADOR</td>
        </tr>
        <tr>
            <td colspan="3"><span class="label-sm">APELLIDOS Y NOMBRES</span><span class="dato-v" id="v-nombre"></span></td>
            <td colspan="7"></td>
        </tr>
        <tr>
            <td colspan="2"><span class="label-sm">EDAD</span><span class="dato-v" id="v-edad"></span></td>
            <td colspan="1" class="bg-gris text-center">SEXO</td>
            <td colspan="2"><span class="label-sm">MASCULINO</span><span class="dato-v" id="v-sex-m"></span></td>
            <td colspan="5"><span class="label-sm">FEMENINO</span><span class="dato-v" id="v-sex-f"></span></td>
        </tr>
        <tr>
            <td colspan="2"><span class="label-sm">FECHA DE NACIMIENTO</span><span class="dato-v" id="v-f-nac"></span></td>
            <td colspan="1" class="text-center"><span class="label-sm">DÍA</span><span id="v-dia"></span></td>
            <td colspan="1" class="text-center"><span class="label-sm">MES</span><span id="v-mes"></span></td>
            <td colspan="1" class="text-center"><span class="label-sm">AÑO</span><span id="v-anio"></span></td>
            <td colspan="5"><span class="label-sm">LUGAR:</span><span id="v-lugar"></span></td>
        </tr>
        <tr>
            <td colspan="3"><span class="label-sm">DOCUMENTO DE IDENTIDAD</span><span class="dato-v" id="v-ci"></span></td>
            <td colspan="7"></td>
        </tr>
        <tr>
            <td colspan="2"><span class="label-sm">DOMICILIO:</span></td>
            <td colspan="3"><span class="label-sm">AV./CALLE</span><span id="v-calle"></span></td>
            <td colspan="5"><span class="label-sm">NUMERO</span><span id="v-num"></span></td>
        </tr>
        <tr>
            <td colspan="3"><span class="label-sm">BARRIO</span><span id="v-barrio"></span></td>
            <td colspan="3"><span class="label-sm">CIUDAD</span><span id="v-ciudad"></span></td>
            <td colspan="4"><span class="label-sm">PAÍS</span><span id="v-pais"></span></td>
        </tr>
        <tr>
            <td colspan="3"><span class="label-sm">TELÉFONO</span><span id="v-tel"></span></td>
            <td colspan="7"></td>
        </tr>
        <tr>
            <td colspan="4"><span class="label-sm">ESTADO CIVIL</span><span id="v-ec"></span></td>
            <td colspan="6"><span class="label-sm">PROFESION O LABOR</span><span id="v-prof"></span></td>
        </tr>
    </table>

    <table class="tabla-oficial">
        <tr><td colspan="4" class="bg-gris">ANTECEDENTES PATOLÓGICOS Y CLÍNICOS</td></tr>
        <tbody id="grid-p2"></tbody>
    </table>

    <table class="tabla-oficial">
        <tr><td colspan="4" class="bg-gris">HÁBITOS Y RIESGOS</td></tr>
        <tbody id="grid-p3"></tbody>
    </table>

    <div class="row text-center firma-container">
        <div class="col-6">
            <div class="linea"></div>
            <span class="label-sm">FIRMA DEL TRABAJADOR</span>
            <b id="f-nom"></b>
        </div>
        <div class="col-6">
            <div class="linea"></div>
            <span class="label-sm">MÉDICO EVALUADOR</span>
        </div>
    </div>
</div>

<script>
    const API = 'https://historial-clinico-936s.onrender.com';
    const p_id = localStorage.getItem('p_id');

    async function cargarData() {
        try {
            const res = await fetch(`${API}/pacientes/`);
            const lista = await res.json();
            const p = lista.find(item => item.id == p_id);

            if(p) {
                // LLENAR SECCIÓN I
                document.getElementById('v-nombre').innerText = p.nombre || '';
                document.getElementById('v-edad').innerText = p.edad || '';
                document.getElementById('v-ci').innerText = p.ci || '';
                document.getElementById('v-sex-m').innerText = p.genero === 'MASCULINO' ? 'X' : '';
                document.getElementById('v-sex-f').innerText = p.genero === 'FEMENINO' ? 'X' : '';
                document.getElementById('v-f-nac').innerText = p.fecha_nacimiento || '';
                document.getElementById('v-calle').innerText = p.direccion || '';
                document.getElementById('v-tel').innerText = p.telefono || '';
                document.getElementById('v-ec').innerText = p.estado_civil || '';
                document.getElementById('v-prof').innerText = p.ocupacion || '';
                document.getElementById('f-nom').innerText = p.nombre || '';

                // LLENAR SECCIÓN II (Ejemplo de mapeo de 22 campos)
                const camposP2 = [
                    ['ALERGIAS', p.alergias], ['CIRUGÍAS', p.cirugias], ['DIABETES', p.diabetes], ['ASMA', p.asma],
                    ['HIPERTENSIÓN', p.hipertension], ['EPILEPSIA', p.epilepsia], ['GASTRITIS', p.gastritis], ['VISIÓN', p.vision]
                ];
                let htmlP2 = "";
                for(let i=0; i < camposP2.length; i+=2) {
                    htmlP2 += `<tr>
                        <td class="label-sm">${camposP2[i][0]}</td><td>${camposP2[i][1] || 'NO'}</td>
                        <td class="label-sm">${camposP2[i+1][0]}</td><td>${camposP2[i+1][1] || 'NO'}</td>
                    </tr>`;
                }
                document.getElementById('grid-p2').innerHTML = htmlP2;

                // LLENAR SECCIÓN III
                const camposP3 = [['FUMA', p.fuma], ['ALCOHOL', p.alcohol], ['DROGAS', p.drogas], ['DEPORTES', p.deportes], ['GRUPO SANG.', p.grupo_sanguineo]];
                document.getElementById('grid-p3').innerHTML = camposP3.map(c => `<tr><td class="label-sm">${c[0]}</td><td colspan="3">${c[1] || '---'}</td></tr>`).join('');

                lanzarPDF(p.nombre);
            }
        } catch(e) { console.error(e); }
    }

    function lanzarPDF(nombre) {
        document.getElementById('hoja-pdf').style.display = 'block';
        document.getElementById('loader').style.display = 'none';
        const opt = { margin: 5, filename: `DJ_${nombre}.pdf`, html2canvas: { scale: 3 }, jsPDF: { unit: 'mm', format: 'a4' } };
        html2pdf().set(opt).from(document.getElementById('hoja-pdf')).save().then(()=> {
            setTimeout(()=> { window.location.href="visor_historial.html"; }, 1500);
        });
    }

    window.onload = cargarData;
</script>
</body>
</html>
