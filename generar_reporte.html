<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>GENERANDO DECLARACIÓN JURADA...</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; font-family: 'Times New Roman', serif; color: #000; }
        #hoja-pdf { 
            width: 210mm; 
            min-height: 297mm; 
            padding: 20mm; 
            margin: auto; 
            background: white; 
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .encabezado { border-bottom: 2px solid #000; margin-bottom: 20px; padding-bottom: 10px; }
        .titulo-doc { text-align: center; font-weight: bold; text-decoration: underline; font-size: 1.4rem; margin: 20px 0; }
        .seccion-titulo { background: #e2e8f0; font-weight: bold; padding: 5px 10px; margin-top: 15px; border: 1px solid #000; text-transform: uppercase; }
        .dato-fila { display: flex; border-bottom: 1px dotted #ccc; padding: 5px 0; font-size: 0.9rem; }
        .label { font-weight: bold; width: 200px; }
        .firma-box { margin-top: 50px; text-align: center; }
        .linea-firma { width: 250px; border-top: 1px solid #000; margin: 80px auto 10px auto; }
        #loader { text-align: center; margin-top: 50px; color: #1e293b; font-family: sans-serif; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner-border text-primary" role="status"></div>
        <h4 class="mt-3">Procesando datos de la nube...</h4>
        <p>Generando Declaración Jurada Médica</p>
    </div>

    <div id="hoja-pdf" style="display: none;">
        <div class="encabezado d-flex justify-content-between align-items-center">
            <div>
                <h5 class="m-0 fw-bold">SISTEMA MÉDICO NUBE</h5>
                <small>HISTORIAL CLÍNICO DIGITAL</small>
            </div>
            <div class="text-end">
                <small>Fecha de Emisión: <span id="fecha-hoy"></span></small><br>
                <small>Código Paciente: <b id="pdf-codigo"></b></small>
            </div>
        </div>

        <div class="titulo-doc">DECLARACIÓN JURADA DE SALUD</div>

        <p class="text-justify mb-4" style="font-size: 0.85rem;">
            Yo, el que suscribe, declaro bajo juramento que la información proporcionada a continuación es verdadera y completa, 
            autorizando su uso estrictamente para fines de historial clínico laboral.
        </p>

        <div class="seccion-titulo">I. DATOS DE FILIACIÓN (P1)</div>
        <div id="datos-p1"></div>

        <div class="seccion-titulo">II. ANTECEDENTES Y PATOLOGÍAS (P2)</div>
        <div id="datos-p2"></div>

        <div class="seccion-titulo">III. HÁBITOS Y RIESGOS (P3)</div>
        <div id="datos-p3"></div>

        <div class="row firma-box">
            <div class="col-6">
                <div class="linea-firma"></div>
                <p class="small">Firma del Paciente<br><span id="firma-nombre" class="fw-bold"></span></p>
            </div>
            <div class="col-6">
                <div class="linea-firma"></div>
                <p class="small">Sello y Firma Médico Responsable</p>
            </div>
        </div>
    </div>

<script>
    const API = 'https://historial-clinico-936s.onrender.com';
    const p_id = localStorage.getItem('p_id');

    async function generar() {
        if(!p_id) { alert("No se encontró ID de paciente"); return; }

        try {
            const res = await fetch(`${API}/pacientes/`);
            const lista = await res.json();
            const p = lista.find(item => item.id == p_id);

            if(p) {
                // Llenar datos generales
                document.getElementById('fecha-hoy').innerText = new Date().toLocaleDateString();
                document.getElementById('pdf-codigo').innerText = p.codigo_paciente || '---';
                document.getElementById('firma-nombre').innerText = p.nombre;

                // Renderizar P1
                document.getElementById('datos-p1').innerHTML = `
                    <div class="dato-fila"><span class="label">Nombres y Apellidos:</span> <span>${p.nombre}</span></div>
                    <div class="dato-fila"><span class="label">Documento CI:</span> <span>${p.ci}</span></div>
                    <div class="dato-fila"><span class="label">Fecha de Nacimiento:</span> <span>${p.fecha_nacimiento || '---'}</span></div>
                `;

                // Renderizar P2 y P3 (Asumiendo que los datos están en el objeto p)
                // Aquí podrías mapear todos los campos que guardamos anteriormente
                document.getElementById('datos-p2').innerHTML = `
                    <div class="dato-fila"><span class="label">Alergias:</span> <span>${p.alergias || 'Ninguna'}</span></div>
                    <div class="dato-fila"><span class="label">Cirugías:</span> <span>${p.cirugias || 'No registra'}</span></div>
                `;

                document.getElementById('datos-p3').innerHTML = `
                    <div class="dato-fila"><span class="label">Fuma:</span> <span>${p.fuma || 'NO'}</span></div>
                    <div class="dato-fila"><span class="label">Deportes:</span> <span>${p.deportes || 'NO'}</span></div>
                    <div class="dato-fila"><span class="label">Grupo Sanguíneo:</span> <span>${p.grupo_sanguineo || '---'}</span></div>
                `;

                // Disparar PDF
                lanzarPDF(p.nombre);
            }
        } catch(e) { console.error(e); }
    }

    function lanzarPDF(nombre) {
        const elemento = document.getElementById('hoja-pdf');
        elemento.style.display = 'block';
        document.getElementById('loader').style.display = 'none';

        const opciones = {
            margin: 0,
            filename: `Declaracion_Jurada_${nombre.replace(/ /g, "_")}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opciones).from(elemento).save().then(() => {
            setTimeout(() => { window.location.href = "visor_historial.html"; }, 2000);
        });
    }

    window.onload = generar;
</script>
</body>
</html>
