<script>
    document.getElementById('p_fecha_hoy').innerText = new Date().toLocaleDateString();

    async function cargarDatos() {
        const id = localStorage.getItem('p_id_reporte');
        if(!id) {
            document.getElementById('p_full_name').innerText = "ERROR: ID NO ENCONTRADO";
            return;
        }

        try {
            // URL corregida sin la barra final problemática
            const res = await fetch(`https://historial-clinico-936s.onrender.com/pacientes/${id}`);
            
            if (!res.ok) throw new Error("Paciente no encontrado");

            const p = await res.json();
            
            // LLENADO DE CAMPOS (P1 MAPEADO TOTALMENTE)
            document.getElementById('p_codigo').innerText = p.codigo_paciente || '---';
            document.getElementById('p_full_name').innerText = `${p.apellido || ''} ${p.nombre || ''}`;
            document.getElementById('p_edad').innerText = p.edad || '---';
            document.getElementById('p_sexo').innerText = p.sexo || '---';
            document.getElementById('p_fecha_nac').innerText = p.fecha_nacimiento || '---';
            document.getElementById('p_lugar_nac').innerText = p.lugar_nacimiento || '---';
            document.getElementById('p_ci').innerText = p.ci || '---';
            document.getElementById('p_estado_civil').innerText = p.estado_civil || '---';
            document.getElementById('p_domicilio').innerText = p.domicilio || '---';
            document.getElementById('p_n_casa').innerText = p.n_casa || '---';
            document.getElementById('p_zona_barrio').innerText = p.zona_barrio || '---';
            document.getElementById('p_ciudad').innerText = p.ciudad || '---';
            document.getElementById('p_pais').innerText = p.pais || '---';
            document.getElementById('p_telf').innerText = p.telefono || '---';
            document.getElementById('p_profesion').innerText = p.profesion_oficio || '---';

        } catch (e) {
            console.error("Error cargando reporte:", e);
            document.getElementById('p_full_name').innerText = "ERROR DE CONEXIÓN";
        }
    }

    function exportarPDF() {
        const element = document.getElementById('area-reporte');
        html2pdf().set({
            margin: 0,
            filename: 'Reporte_Final_P1.pdf',
            html2canvas: { scale: 3 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).from(element).save();
    }

    window.onload = cargarDatos;
</script>
