<script>
    async function cargarDatos() {
        const fechaElem = document.getElementById('p_fecha_hoy');
        if(fechaElem) fechaElem.innerText = new Date().toLocaleDateString();

        const id = localStorage.getItem('p_id_reporte');
        if(!id) return;

        const API_BASE = "https://historial-clinico-936s.onrender.com";

        try {
            // PETICIÓN 1: DATOS BÁSICOS
            const resP = await fetch(`${API_BASE}/pacientes/${id}`);
            if (resP.ok) {
                const p = await resP.json();
                document.getElementById('p_codigo').innerText = p.codigo_paciente || '---';
                document.getElementById('p_full_name').innerText = `${p.apellido || ''} ${p.nombre || ''}`;
                document.getElementById('p_ci').innerText = p.ci || '---';
                document.getElementById('p_fecha_nac').innerText = p.fecha_nacimiento || '---';
            }

            // PETICIÓN 2: FILIACIÓN (P1)
            const resF = await fetch(`${API_BASE}/filiacion/${id}`);
            if (resF.ok) {
                const f = await resF.json();
                const mapping = {
                    'p_edad': f.edad, 'p_sexo': f.sexo, 'p_estado_civil': f.estado_civil,
                    'p_lugar_nac': f.lugar_nacimiento, 'p_domicilio': f.domicilio,
                    'p_n_casa': f.n_casa, 'p_zona_barrio': f.zona_barrio,
                    'p_ciudad': f.ciudad, 'p_pais': f.pais, 'p_telf': f.telefono,
                    'p_profesion': f.profesion_oficio
                };
                for (const [idField, valor] of Object.entries(mapping)) {
                    const el = document.getElementById(idField);
                    if (el) el.innerText = valor || '---';
                }
            }
        } catch (e) {
            console.error("Error:", e);
        }
    }
    window.onload = cargarDatos;
</script>
