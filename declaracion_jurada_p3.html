<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PARTE 3: H√ÅBITOS Y RIESGOS</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background-color: #f0f4f8; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card-container { background: white; border-radius: 35px; box-shadow: 0 15px 35px rgba(0,0,0,0.08); padding: 40px; margin-top: 30px; border: none; }
        .section-title { color: #1e3a8a; font-weight: 800; border-left: 6px solid #22c55e; padding-left: 15px; margin: 30px 0 20px 0; text-transform: uppercase; font-size: 1rem; }
        .form-label { font-weight: 700; color: #475569; font-size: 0.8rem; text-transform: uppercase; }
        .form-control, .form-select { border-radius: 15px; border: 1.5px solid #e2e8f0; padding: 12px; text-transform: uppercase; font-size: 0.9rem; background-color: #f8fafc; }
        .form-control:focus { border-color: #22c55e; box-shadow: none; }
        .btn-add-row { background-color: #334155; color: white; border-radius: 12px; font-weight: 700; border: none; padding: 8px 20px; text-transform: uppercase; font-size: 0.75rem; margin-bottom: 15px; }
        .btn-submit { background-color: #22c55e; color: white; border-radius: 20px; padding: 18px; font-weight: 800; border: none; width: 100%; font-size: 1.2rem; text-transform: uppercase; margin-top: 35px; box-shadow: 0 10px 20px rgba(34, 197, 94, 0.2); }
        .btn-submit:hover { background-color: #16a34a; transform: translateY(-2px); }
        th { background-color: #f1f5f9 !important; color: #475569; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; border: 1px solid #e2e8f0 !important; }
        .check-card { background: #f8fafc; border-radius: 20px; padding: 20px; border: 1.5px solid #e2e8f0; }
        .form-check-label { font-weight: 600; text-transform: uppercase; font-size: 0.8rem; color: #334155; }
    </style>
</head>
<body>
    <div class="container mb-5">
        <div class="card-container">
            <h2 class="text-center mb-5" style="font-weight: 900; color: #0f172a; letter-spacing: -0.02em;">PARTE 3: H√ÅBITOS Y ANTECEDENTES LABORALES</h2>

            <div class="section-title">I. H√ÅBITOS Y OTROS</div>
            <div class="row g-4">
                <div class="col-md-4">
                    <label class="form-label">FUMA</label>
                    <select id="fuma_si_no" class="form-select"><option value="NO">NO</option><option value="SI">SI</option></select>
                    <input type="text" id="fuma_detalle" class="form-control mt-2" placeholder="CANTIDAD">
                </div>
                <div class="col-md-4">
                    <label class="form-label">ALCOHOL</label>
                    <select id="alcohol_si_no" class="form-select"><option value="NO">NO</option><option value="SI">SI</option></select>
                    <input type="text" id="alcohol_detalle" class="form-control mt-2" placeholder="FRECUENCIA">
                </div>
                <div class="col-md-4">
                    <label class="form-label">DROGAS</label>
                    <select id="drogas_si_no" class="form-select"><option value="NO">NO</option><option value="SI">SI</option></select>
                    <input type="text" id="drogas_detalle" class="form-control mt-2" placeholder="TIPO">
                </div>
                <div class="col-md-4">
                    <label class="form-label">PIJCHAR (COCA)</label>
                    <select id="pijchar_si_no" class="form-select"><option value="NO">NO</option><option value="SI">SI</option></select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">DEPORTES</label>
                    <select id="deportes_si_no" class="form-select"><option value="NO">NO</option><option value="SI">SI</option></select>
                    <input type="text" id="deportes_detalle" class="form-control mt-2" placeholder="CUAL/FRECUENCIA">
                </div>
                <div class="col-md-4">
                    <label class="form-label">GRUPO SANGU√çNEO</label>
                    <input type="text" id="grupo_sanguineo" class="form-control" placeholder="EJ. ORH+">
                </div>
            </div>

            <div class="section-title">II. HISTORIA LABORAL (√öLTIMOS EMPLEOS)</div>
            <button class="btn-add-row" onclick="agregarFila()">+ AGREGAR NUEVA FILA</button>
            <div class="table-responsive">
                <table class="table table-bordered align-middle">
                    <thead class="text-center">
                        <tr>
                            <th>EDAD INICIO</th><th>EMPRESA</th><th>OCUPACI√ìN</th><th>TIEMPO</th><th>RIESGOS</th><th>EPP</th>
                        </tr>
                    </thead>
                    <tbody id="tablaLaboral">
                        <tr>
                            <td><input type="number" class="form-control h-edad"></td>
                            <td><input type="text" class="form-control h-emp"></td>
                            <td><input type="text" class="form-control h-ocu"></td>
                            <td><input type="text" class="form-control h-tie"></td>
                            <td><input type="text" class="form-control h-rie"></td>
                            <td><select class="form-select h-epp"><option value="SI">SI</option><option value="NO">NO</option></select></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="section-title">III. RIESGOS EXPUESTOS DURANTE SU VIDA LABORAL</div>
            <div class="check-card row g-3 mx-0">
                <div class="col-6 col-md-3 form-check"><input class="form-check-input check-rie" type="checkbox" value="RUIDO"> <label class="form-check-label">RUIDO</label></div>
                <div class="col-6 col-md-3 form-check"><input class="form-check-input check-rie" type="checkbox" value="VIBRACI√ìN"> <label class="form-check-label">VIBRACI√ìN</label></div>
                <div class="col-6 col-md-3 form-check"><input class="form-check-input check-rie" type="checkbox" value="RADIACI√ìN"> <label class="form-check-label">RADIACI√ìN</label></div>
                <div class="col-6 col-md-3 form-check"><input class="form-check-input check-rie" type="checkbox" value="TEMP. EXTREMAS"> <label class="form-check-label">TEMP. EXTREMAS</label></div>
                <div class="col-6 col-md-3 form-check"><input class="form-check-input check-rie" type="checkbox" value="POLVOS"> <label class="form-check-label">POLVOS</label></div>
                <div class="col-6 col-md-3 form-check"><input class="form-check-input check-rie" type="checkbox" value="GASES/VAPORES"> <label class="form-check-label">GASES/VAPORES</label></div>
                <div class="col-6 col-md-3 form-check"><input class="form-check-input check-rie" type="checkbox" value="ERGON√ìMICOS"> <label class="form-check-label">ERGON√ìMICOS</label></div>
                <div class="col-6 col-md-3 form-check"><input class="form-check-input check-rie" type="checkbox" value="PSICOSOCIAL"> <label class="form-check-label">PSICOSOCIAL</label></div>
            </div>

            <button class="btn-submit" onclick="guardarTodo()">TERMINAR Y GUARDAR REGISTRO üíæ</button>
        </div>
    </div>

    <script>
        const API_BASE = "https://historial-clinico-936s.onrender.com";
        const paciente_id = localStorage.getItem("paciente_id");

        function agregarFila() {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><input type="number" class="form-control h-edad"></td>
                <td><input type="text" class="form-control h-emp"></td>
                <td><input type="text" class="form-control h-ocu"></td>
                <td><input type="text" class="form-control h-tie"></td>
                <td><input type="text" class="form-control h-rie"></td>
                <td><select class="form-select h-epp"><option value="SI">SI</option><option value="NO">NO</option></select></td>`;
            document.getElementById("tablaLaboral").appendChild(tr);
        }

        async function guardarTodo() {
            const historia = [];
            document.querySelectorAll("#tablaLaboral tr").forEach(tr => {
                const fila = {
                    edad: tr.querySelector(".h-edad").value || "0",
                    emp: (tr.querySelector(".h-emp").value || "").toUpperCase(),
                    ocu: (tr.querySelector(".h-ocu").value || "").toUpperCase(),
                    tie: (tr.querySelector(".h-tie").value || "").toUpperCase(),
                    rie: (tr.querySelector(".h-rie").value || "").toUpperCase(),
                    epp: tr.querySelector(".h-epp").value
                };
                if(fila.emp) historia.push(fila);
            });

            const seleccionados = Array.from(document.querySelectorAll(".check-rie:checked")).map(c => c.value);

            const payload = {
                paciente_id: parseInt(paciente_id),
                fuma_si_no: document.getElementById("fuma_si_no").value,
                fuma_detalle: (document.getElementById("fuma_detalle").value || "NINGUNO").toUpperCase(),
                alcohol_si_no: document.getElementById("alcohol_si_no").value,
                alcohol_detalle: (document.getElementById("alcohol_detalle").value || "NINGUNO").toUpperCase(),
                drogas_si_no: document.getElementById("drogas_si_no").value,
                drogas_detalle: (document.getElementById("drogas_detalle").value || "NINGUNO").toUpperCase(),
                pijchar_si_no: document.getElementById("pijchar_si_no").value,
                deportes_si_no: document.getElementById("deportes_si_no").value,
                deportes_detalle: (document.getElementById("deportes_detalle").value || "NINGUNO").toUpperCase(),
                grupo_sanguineo: (document.getElementById("grupo_sanguineo").value || "S/D").toUpperCase(),
                accidentes_si_no: "NO", 
                accidentes_detalle: "N/A",
                medicamentos_si_no: "NO",
                medicamentos_detalle: "N/A",
                historia_laboral: JSON.stringify(historia),
                riesgos_vida_laboral: seleccionados.join(", ") || "NINGUNO"
            };

            try {
                const response = await fetch(`${API_BASE}/declaraciones/p3/`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert("‚úÖ ¬°REGISTRO FINALIZADO CON √âXITO!");
                    window.location.href = "index.html";
                } else {
                    const err = await response.json();
                    alert("‚ùå ERROR: " + JSON.stringify(err));
                }
            } catch (err) {
                alert("üì° ERROR DE RED: VERIFIQUE QUE RENDER EST√â LIVE");
            }
        }
    </script>
</body>
</html>
