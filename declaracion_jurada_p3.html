<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PARTE 3: H√ÅBITOS Y RIESGOS</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        /* Restaurando tu paleta de colores original */
        body { background-color: #f8f9fa; font-family: sans-serif; }
        .section-title { color: #2c3e50; font-weight: bold; margin-top: 20px; border-bottom: 2px solid #eee; }
        /* Bot√≥n verde original */
        .btn-success { background-color: #28a745; border-color: #28a745; padding: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container my-4">
        <h2 class="text-center mb-4">PARTE 3: H√ÅBITOS Y ANTECEDENTES LABORALES</h2>

        <h5 class="section-title">I. H√ÅBITOS</h5>
        <div class="row g-3">
            <div class="col-md-4">
                <label>FUMA</label>
                <select id="fuma_si_no" class="form-select"><option value="NO">NO</option><option value="SI">SI</option></select>
                <input type="text" id="fuma_detalle" class="form-control mt-1" placeholder="CANTIDAD">
            </div>
            <div class="col-md-4">
                <label>ALCOHOL</label>
                <select id="alcohol_si_no" class="form-select"><option value="NO">NO</option><option value="SI">SI</option></select>
                <input type="text" id="alcohol_detalle" class="form-control mt-1" placeholder="FRECUENCIA">
            </div>
            <div class="col-md-4">
                <label>DROGAS</label>
                <select id="drogas_si_no" class="form-select"><option value="NO">NO</option><option value="SI">SI</option></select>
                <input type="text" id="drogas_detalle" class="form-control mt-1" placeholder="TIPO">
            </div>
            <div class="col-md-4">
                <label>PIJCHAR (COCA)</label>
                <select id="pijchar_si_no" class="form-select"><option value="NO">NO</option><option value="SI">SI</option></select>
            </div>
            <div class="col-md-4">
                <label>DEPORTES</label>
                <select id="deportes_si_no" class="form-select"><option value="NO">NO</option><option value="SI">SI</option></select>
                <input type="text" id="deportes_detalle" class="form-control mt-1" placeholder="CU√ÅL">
            </div>
            <div class="col-md-4">
                <label>GRUPO SANGU√çNEO</label>
                <input type="text" id="grupo_sanguineo" class="form-control" placeholder="EJ. ORH+">
            </div>
            <div class="col-md-6">
                <label>ACCIDENTES TRABAJO</label>
                <select id="accidentes_si_no" class="form-select"><option value="NO">NO</option><option value="SI">SI</option></select>
                <input type="text" id="accidentes_detalle" class="form-control mt-1" placeholder="DETALLE">
            </div>
            <div class="col-md-6">
                <label>MEDICAMENTOS ACTUALES</label>
                <select id="medicamentos_si_no" class="form-select"><option value="NO">NO</option><option value="SI">SI</option></select>
                <input type="text" id="medicamentos_detalle" class="form-control mt-1" placeholder="DETALLE">
            </div>
        </div>

        <h5 class="section-title">II. HISTORIA LABORAL (√öLTIMOS EMPLEOS)</h5>
        <button class="btn btn-dark btn-sm mb-2" onclick="agregarFila()">+ AGREGAR FILA</button>
        <table class="table table-bordered">
            <thead class="table-light text-center">
                <tr style="font-size: 0.8rem;">
                    <th>EDAD INICIO</th><th>EMPRESA</th><th>OCUPACI√ìN</th><th>TIEMPO (A√ëOS)</th><th>RIESGOS</th><th>EPP (SI/NO)</th>
                </tr>
            </thead>
            <tbody id="tablaLaboral">
                <tr>
                    <td><input type="number" class="form-control h-edad"></td>
                    <td><input type="text" class="form-control h-emp"></td>
                    <td><input type="text" class="form-control h-ocu"></td>
                    <td><input type="number" class="form-control h-tie"></td>
                    <td><input type="text" class="form-control h-rie"></td>
                    <td><select class="form-select h-epp"><option value="SI">SI</option><option value="NO">NO</option></select></td>
                </tr>
            </tbody>
        </table>

        <h5 class="section-title">III. RIESGOS EXPUESTOS DURANTE SU VIDA LABORAL</h5>
        <div class="row mb-4">
            <div class="col-md-3"><input type="checkbox" class="check-riesgo" value="RUIDO"> RUIDO</div>
            <div class="col-md-3"><input type="checkbox" class="check-riesgo" value="VIBRACI√ìN"> VIBRACI√ìN</div>
            <div class="col-md-3"><input type="checkbox" class="check-riesgo" value="RADIACI√ìN"> RADIACI√ìN</div>
            <div class="col-md-3"><input type="checkbox" class="check-riesgo" value="TEMP. EXTREMAS"> TEMP. EXTREMAS</div>
            <div class="col-md-3"><input type="checkbox" class="check-riesgo" value="POLVOS"> POLVOS</div>
            <div class="col-md-3"><input type="checkbox" class="check-riesgo" value="GASES/VAPORES"> GASES/VAPORES</div>
            <div class="col-md-3"><input type="checkbox" class="check-riesgo" value="ERGON√ìMICOS"> ERGON√ìMICOS</div>
            <div class="col-md-3"><input type="checkbox" class="check-riesgo" value="PSICOSOCIAL"> PSICOSOCIAL</div>
        </div>

        <button class="btn btn-success w-100" onclick="guardarP3()">TERMINAR Y GUARDAR REGISTRO üíæ</button>
    </div>

    <script>
        const API_BASE = "https://historial-clinico-936s.onrender.com";
        const paciente_id = localStorage.getItem("paciente_id");

        function agregarFila() {
            const html = `<tr>
                <td><input type="number" class="form-control h-edad"></td>
                <td><input type="text" class="form-control h-emp"></td>
                <td><input type="text" class="form-control h-ocu"></td>
                <td><input type="number" class="form-control h-tie"></td>
                <td><input type="text" class="form-control h-rie"></td>
                <td><select class="form-select h-epp"><option value="SI">SI</option><option value="NO">NO</option></select></td>
            </tr>`;
            document.getElementById("tablaLaboral").insertAdjacentHTML('beforeend', html);
        }

        async function guardarP3() {
            const historia = [];
            document.querySelectorAll("#tablaLaboral tr").forEach(tr => {
                const fila = {
                    edad: tr.querySelector(".h-edad").value,
                    emp: tr.querySelector(".h-emp").value,
                    ocu: tr.querySelector(".h-ocu").value,
                    tie: tr.querySelector(".h-tie").value,
                    rie: tr.querySelector(".h-rie").value,
                    epp: tr.querySelector(".h-epp").value
                };
                if(fila.emp) historia.push(fila);
            });

            const riesgosSeleccionados = Array.from(document.querySelectorAll(".check-riesgo:checked")).map(ch => ch.value);

            const payload = {
                paciente_id: parseInt(paciente_id),
                fuma_si_no: document.getElementById("fuma_si_no").value,
                fuma_detalle: document.getElementById("fuma_detalle").value || "N/A",
                alcohol_si_no: document.getElementById("alcohol_si_no").value,
                alcohol_detalle: document.getElementById("alcohol_detalle").value || "N/A",
                drogas_si_no: document.getElementById("drogas_si_no").value,
                drogas_detalle: document.getElementById("drogas_detalle").value || "N/A",
                pijchar_si_no: document.getElementById("pijchar_si_no").value,
                deportes_si_no: document.getElementById("deportes_si_no").value,
                deportes_detalle: document.getElementById("deportes_detalle").value || "N/A",
                grupo_sanguineo: document.getElementById("grupo_sanguineo").value || "S/D",
                accidentes_si_no: document.getElementById("accidentes_si_no").value,
                accidentes_detalle: document.getElementById("accidentes_detalle").value || "N/A",
                medicamentos_si_no: document.getElementById("medicamentos_si_no").value,
                medicamentos_detalle: document.getElementById("medicamentos_detalle").value || "N/A",
                historia_laboral: JSON.stringify(historia),
                riesgos_vida_laboral: riesgosSeleccionados.join(", ") || "NINGUNO"
            };

            try {
                const response = await fetch(`${API_BASE}/declaraciones/p3/`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert("‚úÖ Registro Finalizado con √âxito");
                    window.location.href = "index.html";
                } else {
                    const errorData = await response.json();
                    alert("‚ùå Error en el servidor: " + JSON.stringify(errorData));
                }
            } catch (err) {
                alert("üì° Error de conexi√≥n: " + err.message);
            }
        }
    </script>
</body>
</html>
