<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DECLARACI√ìN JURADA - SECCI√ìN 3</title>
    <style>
        :root { --verde: #34a174; --fondo: #f1f5f9; --blanco: #ffffff; --texto: #1e293b; --placeholder: #94a3b8; }
        body { background-color: var(--fondo); font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; padding: 20px; text-transform: uppercase; }
        .card { background: var(--blanco); padding: 40px; border-radius: 50px; width: 100%; max-width: 850px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        h2 { color: #0f172a; text-align: center; font-size: 22px; margin-bottom: 5px; letter-spacing: 1px; }
        .subtitulo { text-align: center; font-size: 10px; color: var(--placeholder); margin-bottom: 30px; font-weight: 700; }
        .seccion-header { color: #0f172a; font-weight: 900; font-size: 14px; margin: 25px 0 15px 0; display: flex; align-items: center; }
        .seccion-header::before { content: ""; width: 4px; height: 18px; background: var(--verde); margin-right: 10px; border-radius: 2px; }
        .mini-label { font-size: 9px; font-weight: 800; color: var(--verde); margin-bottom: 8px; display: block; }
        .grid-habitos { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .habito-item { background: #f8fafc; padding: 10px; border-radius: 15px; }
        select, input, textarea { width: 100%; padding: 12px; border: none; border-radius: 10px; background: #f1f5f9; font-size: 11px; font-weight: 700; color: var(--texto); box-sizing: border-box; text-transform: uppercase; }
        textarea { height: 90px; resize: none; font-family: inherit; }
        .grid-riesgos { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px; }
        .label-ejemplo { font-size: 9px; color: var(--placeholder); font-weight: 600; margin-bottom: 5px; display: block; }
        .btn-finalizar { background: var(--verde); color: white; border: none; padding: 18px; border-radius: 15px; width: 100%; font-weight: 800; font-size: 15px; cursor: pointer; margin-top: 30px; transition: 0.3s; }
        .btn-finalizar:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-regresar { background: #f1f5f9; color: var(--placeholder); border: none; padding: 12px; border-radius: 15px; width: 100%; font-weight: 800; font-size: 11px; cursor: pointer; margin-top: 10px; }
        ::placeholder { color: var(--placeholder); font-weight: 400; opacity: 0.7; }
    </style>
</head>
<body>
    <div class="card">
        <h2>DECLARACI√ìN JURADA DE SALUD</h2>
        <p class="subtitulo">SECCI√ìN 3: H√ÅBITOS Y RIESGOS</p>

        <form id="formP3">
            <div class="seccion-header">III. H√ÅBITOS Y VIDA LABORAL</div>
            
            <p class="mini-label">H√ÅBITOS PERSONALES</p>
            <div class="grid-habitos">
                <div class="habito-item">
                    <label class="label-ejemplo">¬øFUMA?</label>
                    <select id="fuma"><option value="NO">NO</option><option value="SI">SI</option></select>
                    <input type="text" id="fuma_det" placeholder="CANT./FRECUENCIA" style="margin-top:8px">
                </div>
                <div class="habito-item">
                    <label class="label-ejemplo">¬øBEBE ALCOHOL?</label>
                    <select id="bebe"><option value="NO">NO</option><option value="SI">SI</option></select>
                    <input type="text" id="bebe_det" placeholder="CANT./FRECUENCIA" style="margin-top:8px">
                </div>
                <div class="habito-item">
                    <label class="label-ejemplo">¬øCONSUME DROGAS?</label>
                    <select id="drogas"><option value="NO">NO</option><option value="SI">SI</option></select>
                    <input type="text" id="drogas_det" placeholder="TIPO/FRECUENCIA" style="margin-top:8px">
                </div>
                <div class="habito-item">
                    <label class="label-ejemplo">¬øMEDICAMENTOS?</label>
                    <select id="meds"><option value="NO">NO</option><option value="SI">SI</option></select>
                    <input type="text" id="meds_det" placeholder="¬øCU√ÅLES?" style="margin-top:8px">
                </div>
            </div>

            <div class="seccion-header">ANTECEDENTES OCUPACIONALES</div>
            <label class="label-ejemplo">HISTORIAL DE TRABAJO ANTERIOR</label>
            <textarea id="historial_lab" placeholder="EDAD INICIO: 18, EMPRESA: ABC, OCUPACI√ìN: OBRERO, TIEMPO: 2 A√ëOS, RIESGOS: RUIDO, EPP: CASCO Y TAPONES."></textarea>

            <div class="seccion-header">ANTECEDENTES DE RIESGO (EXPOSICI√ìN ACTUAL)</div>
            <div class="grid-riesgos">
                <div>
                    <label class="label-ejemplo">F√çSICOS</label>
                    <input type="text" id="r_fisico" placeholder="RUIDO, CALOR, RADIACI√ìN, VIBRACI√ìN">
                </div>
                <div>
                    <label class="label-ejemplo">ERGON√ìMICOS</label>
                    <input type="text" id="r_ergonomico" placeholder="POSTURAS, CARGA PESADA, MOV. REPETITIVOS">
                </div>
                <div>
                    <label class="label-ejemplo">QU√çMICOS</label>
                    <input type="text" id="r_quimico" placeholder="POLVOS, HUMOS, GASES, VAPORES">
                </div>
                <div>
                    <label class="label-ejemplo">PSICOLOG√çA LABORAL</label>
                    <input type="text" id="r_psico" placeholder="ESTR√âS, TURNOS NOCTURNOS, CARGA MENTAL">
                </div>
            </div>
            <div style="margin-top:15px">
                <label class="label-ejemplo">OBSERVACIONES DE RIESGO</label>
                <input type="text" id="r_obs" placeholder="ESPECIFIQUE OTROS DETALLES RELEVANTES AQU√ç">
            </div>

            <button type="submit" id="btnFinalizar" class="btn-finalizar">FINALIZAR Y GUARDAR HISTORIAL üíæ</button>
            <button type="button" class="btn-regresar" onclick="history.back()">REGRESAR</button>
        </form>
    </div>

    <script>
        const API_URL = 'https://historial-clinico-936s.onrender.com/declaraciones/p3/';

        document.getElementById('formP3').addEventListener('submit', async (e) => {
            e.preventDefault();
            const pacId = localStorage.getItem('paciente_id');
            const btn = document.getElementById('btnFinalizar');

            if (!pacId) { alert("Error: No hay ID de paciente"); return; }

            btn.innerText = "GUARDANDO TODO EL EXPEDIENTE...";
            btn.disabled = true;

            const payload = {
                paciente_id: parseInt(pacId),
                fuma: document.getElementById('fuma').value,
                fuma_det: document.getElementById('fuma_det').value.trim() || "SIN DETALLE",
                bebe: document.getElementById('bebe').value,
                bebe_det: document.getElementById('bebe_det').value.trim() || "SIN DETALLE",
                drogas: document.getElementById('drogas').value,
                drogas_det: document.getElementById('drogas_det').value.trim() || "SIN DETALLE",
                meds: document.getElementById('meds').value,
                meds_det: document.getElementById('meds_det').value.trim() || "SIN DETALLE",
                historial_lab: document.getElementById('historial_lab').value.trim() || "SIN ANTECEDENTES",
                r_fisico: document.getElementById('r_fisico').value.trim() || "SIN RIESGO EXPEC√çFICO",
                r_ergonomico: document.getElementById('r_ergonomico').value.trim() || "SIN RIESGO EXPEC√çFICO",
                r_quimico: document.getElementById('r_quimico').value.trim() || "SIN RIESGO EXPEC√çFICO",
                r_psico: document.getElementById('r_psico').value.trim() || "SIN RIESGO EXPEC√çFICO",
                r_obs: document.getElementById('r_obs').value.trim() || "NINGUNA"
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                if(response.ok) {
                    alert("‚úì DECLARACI√ìN JURADA COMPLETADA Y GUARDADA");
                    window.location.href = "enfermera.html"; // O a donde desees redirigir al final
                } else {
                    alert("ERROR AL GUARDAR SECCI√ìN 3");
                }
            } catch (err) {
                alert("ERROR DE CONEXI√ìN CON EL SERVIDOR");
            } finally {
                btn.disabled = false;
                btn.innerText = "FINALIZAR Y GUARDAR HISTORIAL üíæ";
            }
        });
    </script>
</body>
</html>
