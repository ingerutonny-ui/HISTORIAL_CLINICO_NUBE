<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PARTE 3: H√ÅBITOS Y RIESGOS</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        .card { border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .section-title { color: #2c3e50; border-left: 5px solid #27ae60; padding-left: 10px; margin-bottom: 20px; font-weight: bold; }
        .btn-success { background-color: #27ae60; border: none; padding: 12px 30px; border-radius: 10px; font-weight: bold; }
        .btn-success:hover { background-color: #219150; }
    </style>
</head>
<body>
    <div class="container my-5">
        <div class="card p-4">
            <h2 class="text-center mb-4">PARTE 3: H√ÅBITOS Y ANTECEDENTES LABORALES</h2>

            <div class="section-title">I. H√ÅBITOS</div>
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <label class="form-label">FUMA</label>
                    <select id="fuma_si_no" class="form-select"><option value="NO">NO</option><option value="SI">SI</option></select>
                    <input type="text" id="fuma_detalle" class="form-control mt-2" placeholder="CANTIDAD">
                </div>
                <div class="col-md-4">
                    <label class="form-label">ALCOHOL</label>
                    <select id="alcohol_si_no" class="form-select"><option value="NO">NO</option><option value="SI">SI</option></select>
                    <input type="text" id="alcohol_detalle" class="form-control mt-2" placeholder="FRECUENCIA">
                </div>
                <div class="col-md-4">
                    <label class="form-label">DROGAS</label>
                    <select id="drogas_si_no" class="form-select"><option value="NO">NO</option><option value="SI">SI</option></select>
                    <input type="text" id="drogas_detalle" class="form-control mt-2" placeholder="TIPO">
                </div>
                <div class="col-md-4">
                    <label class="form-label">PIJCHAR (COCA)</label>
                    <select id="pijchar_si_no" class="form-select"><option value="NO">NO</option><option value="SI">SI</option></select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">DEPORTES</label>
                    <select id="deportes_si_no" class="form-select"><option value="NO">NO</option><option value="SI">SI</option></select>
                    <input type="text" id="deportes_detalle" class="form-control mt-2" placeholder="CU√ÅL">
                </div>
                <div class="col-md-4">
                    <label class="form-label">GRUPO SANGU√çNEO</label>
                    <input type="text" id="grupo_sanguineo" class="form-control" placeholder="EJ. ORH+">
                </div>
                <div class="col-md-6">
                    <label class="form-label">ACCIDENTES TRABAJO</label>
                    <select id="accidentes_si_no" class="form-select"><option value="NO">NO</option><option value="SI">SI</option></select>
                    <input type="text" id="accidentes_detalle" class="form-control mt-2" placeholder="DETALLE">
                </div>
                <div class="col-md-6">
                    <label class="form-label">MEDICAMENTOS ACTUALES</label>
                    <select id="medicamentos_si_no" class="form-select"><option value="NO">NO</option><option value="SI">SI</option></select>
                    <input type="text" id="medicamentos_detalle" class="form-control mt-2" placeholder="DETALLE">
                </div>
            </div>

            <div class="section-title">II. HISTORIA LABORAL (√öLTIMOS EMPLEOS)</div>
            <button class="btn btn-sm btn-dark mb-2" onclick="agregarFila()">+ AGREGAR FILA</button>
            <table class="table table-bordered align-middle text-center" style="font-size: 0.9rem;">
                <thead class="table-light">
                    <tr>
                        <th>EDAD INICIO</th><th>EMPRESA</th><th>OCUPACI√ìN</th><th>TIEMPO (A√ëOS)</th><th>RIESGOS</th><th>EPP (SI/NO)</th>
                    </tr>
                </thead>
                <tbody id="tablaLaboral">
                    <tr>
                        <td><input type="number" class="form-control form-control-sm h-edad"></td>
                        <td><input type="text" class="form-control form-control-sm h-emp"></td>
                        <td><input type="text" class="form-control form-control-sm h-ocu"></td>
                        <td><input type="number" class="form-control form-control-sm h-tie"></td>
                        <td><input type="text" class="form-control form-control-sm h-rie"></td>
                        <td><select class="form-select form-select-sm h-epp"><option value="SI">SI</option><option value="NO">NO</option></select></td>
                    </tr>
                </tbody>
            </table>

            <div class="section-title">III. RIESGOS EXPUESTOS DURANTE SU VIDA LABORAL</div>
            <div class="row px-3 mb-4">
                <div class="form-check col-md-3"><input class="form-check-input check-riesgo" type="checkbox" value="RUIDO"> RUIDO</div>
                <div class="form-check col-md-3"><input class="form-check-input check-riesgo" type="checkbox" value="VIBRACI√ìN"> VIBRACI√ìN</div>
                <div class="form-check col-md-3"><input class="form-check-input check-riesgo" type="checkbox" value="RADIACI√ìN"> RADIACI√ìN</div>
                <div class="form-check col-md-3"><input class="form-check-input check-riesgo" type="checkbox" value="TEMP. EXTREMAS"> TEMP. EXTREMAS</div>
                <div class="form-check col-md-3"><input class="form-check-input check-riesgo" type="checkbox" value="POLVOS"> POLVOS</div>
                <div class="form-check col-md-3"><input class="form-check-input check-riesgo" type="checkbox" value="GASES/VAPORES"> GASES/VAPORES</div>
                <div class="form-check col-md-3"><input class="form-check-input check-riesgo" type="checkbox" value="ERGON√ìMICOS"> ERGON√ìMICOS</div>
                <div class="form-check col-md-3"><input class="form-check-input check-riesgo" type="checkbox" value="PSICOSOCIAL"> PSICOSOCIAL</div>
            </div>

            <button class="btn btn-success w-100" onclick="guardarP3()">TERMINAR Y GUARDAR REGISTRO üíæ</button>
        </div>
    </div>

    <script>
        const API_BASE = "https://historial-clinico-936s.onrender.com";
        const paciente_id = localStorage.getItem("paciente_id");

        if (!paciente_id) {
            alert("No hay paciente seleccionado. Regrese al inicio.");
            window.location.href = "registro_paciente.html";
        }

        function agregarFila() {
            const html = `<tr>
                <td><input type="number" class="form-control form-control-sm h-edad"></td>
                <td><input type="text" class="form-control form-control-sm h-emp"></td>
                <td><input type="text" class="form-control form-control-sm h-ocu"></td>
                <td><input type="number" class="form-control form-control-sm h-tie"></td>
                <td><input type="text" class="form-control form-control-sm h-rie"></td>
                <td><select class="form-select form-select-sm h-epp"><option value="SI">SI</option><option value="NO">NO</option></select></td>
            </tr>`;
            document.getElementById("tablaLaboral").insertAdjacentHTML('beforeend', html);
        }

        async function guardarP3() {
            // Recolectar Historia Laboral
            const historia = [];
            document.querySelectorAll("#tablaLaboral tr").forEach(tr => {
                const fila = {
                    edad: tr.querySelector(".h-edad").value,
                    emp: tr.querySelector(".h-emp").value,
                    ocu: tr.querySelector(".h-ocu").value,
                    tie: tr.querySelector(".h-tie").value,
                    rie: tr.querySelector(".h-rie").value,
                    epp: tr.querySelector(".h-epp").value
                };
                if(fila.emp) historia.push(fila);
            });

            // Recolectar Riesgos Checkboxes
            const riesgosSeleccionados = [];
            document.querySelectorAll(".check-riesgo:checked").forEach(ch => {
                riesgosSeleccionados.push(ch.value);
            });

            const data = {
                paciente_id: parseInt(paciente_id),
                fuma_si_no: document.getElementById("fuma_si_no").value,
                fuma_detalle: document.getElementById("fuma_detalle").value,
                alcohol_si_no: document.getElementById("alcohol_si_no").value,
                alcohol_detalle: document.getElementById("alcohol_detalle").value,
                drogas_si_no: document.getElementById("drogas_si_no").value,
                drogas_detalle: document.getElementById("drogas_detalle").value,
                pijchar_si_no: document.getElementById("pijchar_si_no").value,
                deportes_si_no: document.getElementById("deportes_si_no").value,
                deportes_detalle: document.getElementById("deportes_detalle").value,
                grupo_sanguineo: document.getElementById("grupo_sanguineo").value,
                accidentes_si_no: document.getElementById("accidentes_si_no").value,
                accidentes_detalle: document.getElementById("accidentes_detalle").value,
                medicamentos_si_no: document.getElementById("medicamentos_si_no").value,
                medicamentos_detalle: document.getElementById("medicamentos_detalle").value,
                historia_laboral: JSON.stringify(historia),
                riesgos_vida_laboral: riesgosSeleccionados.join(", ")
            };

            try {
                const res = await fetch(`${API_BASE}/declaraciones/p3/`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    alert("¬°Registro guardado exitosamente!");
                    window.location.href = `index.html`; 
                } else {
                    const err = await res.json();
                    alert("Error al guardar: " + JSON.stringify(err));
                }
            } catch (e) {
                alert("Error de red: " + e.message);
            }
        }
    </script>
</body>
</html>
