<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DECLARACI√ìN JURADA - SECCI√ìN 3</title>
    <style>
        :root { --verde: #34a174; --fondo: #f1f5f9; --blanco: #ffffff; --texto: #1e293b; --placeholder: #94a3b8; }
        body { background-color: var(--fondo); font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; padding: 20px; text-transform: uppercase; }
        .card { background: var(--blanco); padding: 40px; border-radius: 50px; width: 100%; max-width: 850px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        h2 { color: #0f172a; text-align: center; font-size: 22px; margin-bottom: 5px; letter-spacing: 1px; }
        .subtitulo { text-align: center; font-size: 10px; color: var(--placeholder); margin-bottom: 30px; font-weight: 700; }
        .paciente-info { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; margin-bottom: 25px; background: #f8fafc; padding: 15px; border-radius: 20px; border: 1px solid #e2e8f0; }
        .info-item { display: flex; flex-direction: column; }
        .info-item label { font-size: 9px; color: #94a3b8; margin: 0; text-transform: uppercase; }
        .info-item span { font-weight: 800; color: var(--verde); font-size: 13px; }
        .seccion-header { color: #0f172a; font-weight: 900; font-size: 14px; margin: 25px 0 15px 0; display: flex; align-items: center; }
        .seccion-header::before { content: ""; width: 4px; height: 18px; background: var(--verde); margin-right: 10px; border-radius: 2px; }
        .label-grupo { display: flex; justify-content: flex-start; align-items: baseline; gap: 10px; margin-bottom: 8px; }
        .titulo-txt { font-size: 10px; font-weight: 800; color: #1e293b; }
        .ejemplo-txt { font-size: 9px; font-weight: 600; color: var(--placeholder); font-style: italic; }
        .grid-habitos { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .habito-item { background: #f8fafc; padding: 12px; border-radius: 15px; border: 1px solid #e2e8f0; }
        select, input, textarea { width: 100%; padding: 12px; border: none; border-radius: 10px; background: #f1f5f9; font-size: 11px; font-weight: 700; color: var(--texto); box-sizing: border-box; text-transform: uppercase; outline: none; border: 2px solid transparent; }
        input:focus, textarea:focus { border-color: #d1eadd; background: white; }
        textarea { height: 100px; resize: none; font-family: inherit; }
        .grid-riesgos { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px; }
        .campo-riesgo { margin-bottom: 15px; }
        .btn-finalizar { background: var(--verde); color: white; border: none; padding: 18px; border-radius: 25px; width: 100%; font-weight: 800; font-size: 15px; cursor: pointer; margin-top: 30px; transition: 0.3s; box-shadow: 0 4px 12px rgba(52, 161, 116, 0.2); }
        .btn-finalizar:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-regresar { background: #f1f5f9; color: var(--placeholder); border: none; padding: 12px; border-radius: 15px; width: 100%; font-weight: 800; font-size: 11px; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="card">
        <h2>DECLARACI√ìN JURADA DE SALUD</h2>
        <p class="subtitulo">SECCI√ìN 3: H√ÅBITOS Y VIDA LABORAL</p>

        <div class="paciente-info">
            <div class="info-item"><label>PACIENTE:</label><span id="txt_nombre">...</span></div>
            <div class="info-item"><label>DOCUMENTO:</label><span id="txt_ci">...</span></div>
            <div class="info-item"><label>C√ìDIGO:</label><span id="txt_codigo">...</span></div>
        </div>

        <form id="formP3">
            <div class="seccion-header">I. H√ÅBITOS PERSONALES</div>
            <div class="grid-habitos">
                <div class="habito-item">
                    <div class="label-grupo"><span class="titulo-txt">¬øFUMA?</span></div>
                    <select id="fuma"><option value="NO">NO</option><option value="SI">SI</option></select>
                    <input type="text" id="fuma_det" placeholder="CANT./FRECUENCIA" style="margin-top:8px">
                </div>
                <div class="habito-item">
                    <div class="label-grupo"><span class="titulo-txt">¬øALCOHOL?</span></div>
                    <select id="bebe"><option value="NO">NO</option><option value="SI">SI</option></select>
                    <input type="text" id="bebe_det" placeholder="CANT./FRECUENCIA" style="margin-top:8px">
                </div>
                <div class="habito-item">
                    <div class="label-grupo"><span class="titulo-txt">¬øDROGAS?</span></div>
                    <select id="drogas"><option value="NO">NO</option><option value="SI">SI</option></select>
                    <input type="text" id="drogas_det" placeholder="TIPO/FRECUENCIA" style="margin-top:8px">
                </div>
                <div class="habito-item">
                    <div class="label-grupo"><span class="titulo-txt">¬øMEDS?</span></div>
                    <select id="meds"><option value="NO">NO</option><option value="SI">SI</option></select>
                    <input type="text" id="meds_det" placeholder="¬øCU√ÅLES?" style="margin-top:8px">
                </div>
            </div>

            <div class="seccion-header">II. ANTECEDENTES OCUPACIONALES</div>
            <div class="label-grupo">
                <span class="titulo-txt">HISTORIAL LABORAL</span>
                <span class="ejemplo-txt">(EDAD, EMPRESA, OCUPACI√ìN, TIEMPO, RIESGOS, EPP)</span>
            </div>
            <textarea id="historial_lab" placeholder="EJ: 18 A√ëOS, EMPRESA MINERA, OBRERO, 5 A√ëOS, RUIDO Y POLVO..."></textarea>

            <div class="seccion-header">III. ANTECEDENTES DE RIESGO (EXPOSICI√ìN ACTUAL)</div>
            <div class="grid-riesgos">
                <div class="campo-riesgo">
                    <div class="label-grupo"><span class="titulo-txt">F√çSICOS</span><span class="ejemplo-txt">(RUIDO, CALOR, RADIACI√ìN)</span></div>
                    <input type="text" id="r_fisico" placeholder="ESCRIBA AQU√ç LOS RIESGOS">
                </div>
                <div class="campo-riesgo">
                    <div class="label-grupo"><span class="titulo-txt">ERGON√ìMICOS</span><span class="ejemplo-txt">(POSTURAS, CARGA)</span></div>
                    <input type="text" id="r_ergonomico" placeholder="ESCRIBA AQU√ç LOS RIESGOS">
                </div>
                <div class="campo-riesgo">
                    <div class="label-grupo"><span class="titulo-txt">QU√çMICOS</span><span class="ejemplo-txt">(POLVOS, HUMOS, GASES)</span></div>
                    <input type="text" id="r_quimico" placeholder="ESCRIBA AQU√ç LOS RIESGOS">
                </div>
                <div class="campo-riesgo">
                    <div class="label-grupo"><span class="titulo-txt">PSICOLOG√çA</span><span class="ejemplo-txt">(ESTR√âS, TURNOS)</span></div>
                    <input type="text" id="r_psico" placeholder="ESCRIBA AQU√ç LOS RIESGOS">
                </div>
            </div>
            <div style="margin-top:10px">
                <div class="label-grupo"><span class="titulo-txt">OBSERVACIONES</span><span class="ejemplo-txt">(OTROS DETALLES RELEVANTES)</span></div>
                <input type="text" id="r_obs" placeholder="NINGUNA">
            </div>

            <button type="submit" id="btnFinalizar" class="btn-finalizar">FINALIZAR Y GUARDAR HISTORIAL üíæ</button>
            <button type="button" class="btn-regresar" onclick="location.href='declaracion_jurada_p2.html'">REGRESAR A SECCI√ìN ANTERIOR</button>
        </form>
    </div>

    <script>
        const API_URL = 'https://historial-clinico-936s.onrender.com/declaraciones/p3';

        window.onload = () => {
            const id = localStorage.getItem('paciente_id');
            if (!id) {
                alert("‚ö†Ô∏è SESI√ìN INV√ÅLIDA. REGRESE AL REGISTRO.");
                window.location.href = "registro_paciente.html";
                return;
            }
            document.getElementById('txt_nombre').innerText = localStorage.getItem('paciente_nombre');
            document.getElementById('txt_ci').innerText = localStorage.getItem('paciente_ci');
            document.getElementById('txt_codigo').innerText = localStorage.getItem('paciente_codigo');
        };

        document.getElementById('formP3').addEventListener('submit', async (e) => {
            e.preventDefault();
            const pacId = localStorage.getItem('paciente_id');
            const btn = document.getElementById('btnFinalizar');

            btn.innerText = "REGISTRANDO EN LA NUBE...";
            btn.disabled = true;

            const val = (id, def) => document.getElementById(id).value.trim().toUpperCase() || def;

            const payload = {
                paciente_id: parseInt(pacId),
                fuma: document.getElementById('fuma').value,
                fuma_det: val('fuma_det', "NO REFIERE"),
                bebe: document.getElementById('bebe').value,
                bebe_det: val('bebe_det', "NO REFIERE"),
                drogas: document.getElementById('drogas').value,
                drogas_det: val('drogas_det', "NO REFIERE"),
                meds: document.getElementById('meds').value,
                meds_det: val('meds_det', "NO CONSUME"),
                historial_laboral: val('historial_lab', "SIN ANTECEDENTES"),
                riesgo_fisico: val('r_fisico', "SIN RIESGO"),
                riesgo_ergonomico: val('r_ergonomico', "SIN RIESGO"),
                riesgo_quimico: val('r_quimico', "SIN RIESGO"),
                riesgo_psicologico: val('r_psico', "SIN RIESGO"),
                observaciones: val('r_obs', "NINGUNA")
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                if(response.ok) {
                    alert("‚úì HISTORIAL M√âDICO COMPLETADO Y GUARDADO EN LA NUBE");
                    localStorage.clear();
                    window.location.href = "index.html"; 
                } else {
                    const err = await response.json();
                    alert("ERROR SERVIDOR: " + JSON.stringify(err.detail));
                }
            } catch (err) { alert("ERROR DE CONEXI√ìN: VERIFIQUE RENDER"); }
            finally { btn.disabled = false; btn.innerText = "FINALIZAR Y GUARDAR HISTORIAL üíæ"; }
        });
    </script>
</body>
</html>
