<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REGISTRO DE PACIENTE | OHS</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; }
        .logo { width: 120px; margin-bottom: 10px; }
        h2 { color: #1a2b40; font-size: 1.4rem; margin-bottom: 25px; }
        .input-group { text-align: left; margin-bottom: 15px; }
        label { font-size: 0.75rem; font-weight: bold; color: #1a2b40; text-transform: uppercase; margin-left: 5px; }
        input { width: 100%; padding: 12px; margin-top: 5px; border: 2px solid #e1e4e8; border-radius: 12px; box-sizing: border-box; font-size: 1rem; transition: 0.3s; }
        input:focus { border-color: #2ecc71; outline: none; }
        
        .codigo-container { 
            background: #f8f9fa; border: 2px dashed #d1d5db; border-radius: 15px; 
            padding: 15px; margin-top: 20px; min-height: 60px;
        }
        .codigo-label { font-size: 0.65rem; color: #6b7280; text-transform: uppercase; }
        #display-codigo { font-size: 2rem; font-weight: 900; color: #1a2b40; letter-spacing: 2px; margin-top: 5px; }

        .btn-guardar { 
            width: 100%; background: #2ecc71; color: white; border: none; 
            padding: 15px; border-radius: 12px; font-weight: bold; font-size: 1rem; 
            cursor: pointer; margin-top: 20px; transition: 0.3s;
        }
        .btn-guardar:hover { background: #27ae60; transform: translateY(-2px); }
    </style>
</head>
<body>

<div class="card">
    <img src="https://ingerutonny-ui.github.io/HISTORIAL_CLINICO_NUBE/logo_ohs.png" alt="Logo OHS" class="logo">
    <h2>REGISTRO DE PACIENTE</h2>

    <div class="input-group">
        <label>Nombres Completos</label>
        <input type="text" id="nombre" placeholder="Ej. ELMER" oninput="generarCodigo()">
    </div>

    <div class="input-group">
        <label>Apellidos Paterno/Materno</label>
        <input type="text" id="apellido" placeholder="Ej. HERMOSA" oninput="generarCodigo()">
    </div>

    <div class="input-group">
        <label>Cédula de Identidad (CI)</label>
        <input type="number" id="ci" placeholder="Ej. 12345" oninput="generarCodigo()">
    </div>

    <div class="codigo-container">
        <div class="codigo-label">Código Generado</div>
        <div id="display-codigo">----</div>
    </div>

    <button class="btn-guardar" onclick="enviarDatos()">GUARDAR REGISTRO FINAL</button>
</div>

<script>
    const API_URL = 'https://historial-clinico-936s.onrender.com';

    function generarCodigo() {
        const nombre = document.getElementById('nombre').value.trim().toUpperCase();
        const apellido = document.getElementById('apellido').value.trim().toUpperCase();
        const ci = document.getElementById('ci').value.trim();
        const display = document.getElementById('display-codigo');

        if (nombre && apellido && ci) {
            const inicialNombre = nombre.charAt(0);
            const inicialApellido = apellido.charAt(0);
            const ultimosCuatro = ci.slice(-4);
            const codigo = inicialNombre + inicialApellido + ultimosCuatro;
            display.innerText = codigo;
            return codigo;
        } else {
            display.innerText = "----";
            return "";
        }
    }

    async function enviarDatos() {
        const codigo = generarCodigo();
        if (!codigo) { alert("Inge, complete todos los campos primero."); return; }

        const datos = {
            nombre: document.getElementById('nombre').value.toUpperCase(),
            apellido: document.getElementById('apellido').value.toUpperCase(),
            ci: document.getElementById('ci').value,
            codigo_paciente: codigo
        };

        try {
            // INGE: Limpieza total de sesión previa para evitar datos "fantasma"
            localStorage.clear();

            const response = await fetch(`${API_URL}/pacientes/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datos)
            });

            if (response.ok) {
                const paciente = await response.json();
                // Sincronizamos con los nombres exactos que espera tu P1
                localStorage.setItem('p_id', paciente.id);
                localStorage.setItem('p_nom', `${paciente.apellido} ${paciente.nombre}`);
                localStorage.setItem('p_ci', paciente.ci);
                localStorage.setItem('p_cod', paciente.codigo_paciente);
                
                alert("✅ Paciente registrado con éxito.");
                window.location.href = 'declaracion_jurada_p1.html';
            } else {
                alert("❌ Error al guardar en la nube.");
            }
        } catch (error) {
            alert("❌ No hay conexión con el servidor.");
        }
    }
</script>
</body>
</html>
