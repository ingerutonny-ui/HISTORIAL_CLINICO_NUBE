<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>REGISTRO - HISTORIAL CLÍNICO NUBE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background:#f8f9fa; font-family:'Segoe UI',sans-serif; display:flex; flex-direction:column; align-items:center; padding-top:50px; }
        .box { max-width:400px; width:95%; background:white; padding:40px; border-radius:30px; box-shadow:0 10px 40px rgba(0,0,0,0.05); }
        .label { font-size:11px; font-weight:700; color:#a0aab4; text-transform:uppercase; margin-bottom:5px; display:block; }
        .form-control { border-radius:12px; background:#f4f7fa; border:none; padding:12px; margin-bottom:20px; font-weight:600; }
        #codigo_display { background:#f0f4ff!important; color:#2d6df6!important; text-align:center; font-weight:800; display:none; }
        .btn-reg { background:#2d6df6; border:none; border-radius:12px; padding:15px; font-weight:700; width:100%; color:white; }
    </style>
</head>
<body>
    <div class="box">
        <h2 class="text-center" style="font-weight:800; color:#1a2b4b;">REGISTRO</h2>
        <form id="formRegistro">
            <span class="label">NOMBRES</span>
            <input type="text" id="nombres" class="form-control" required autocomplete="off">
            <span class="label">APELLIDOS</span>
            <input type="text" id="apellidos" class="form-control" required autocomplete="off">
            <span class="label">DOCUMENTO (CI)</span>
            <input type="text" id="ci" class="form-control" required autocomplete="off">
            <span class="label" id="l_cod" style="display:none; text-align:center;">CÓDIGO GENERADO</span>
            <input type="text" id="codigo_display" class="form-control" readonly>
            <button type="submit" id="btn" class="btn-reg">REGISTRAR PACIENTE</button>
        </form>
    </div>

    <script>
        const API = 'https://historial-clinico-936s.onrender.com/pacientes/';
        const n = document.getElementById('nombres');
        const a = document.getElementById('apellidos');
        const c = document.getElementById('codigo_display');

        function generar() {
            if(n.value && a.value) {
                if(!c.value) c.value = n.value[0].toUpperCase() + a.value[0].toUpperCase() + Math.floor(1000+Math.random()*9000);
                c.style.display = 'block';
                document.getElementById('l_cod').style.display = 'block';
            }
        }
        n.oninput = generar; a.oninput = generar;

        document.getElementById('formRegistro').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn');
            btn.innerText = "GUARDANDO...";
            btn.disabled = true;

            const payload = {
                nombres: n.value,
                apellidos: a.value,
                documento_identidad: document.getElementById('ci').value,
                codigo_paciente: c.value
            };

            try {
                const r = await fetch(API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if(r.ok) { alert("PACIENTE REGISTRADO"); location.reload(); }
                else { const e = await r.json(); alert(e.detail || "Error"); }
            } catch (err) {
                alert("FALLO DE RED: El navegador bloqueó la conexión.");
            } finally {
                btn.innerText = "REGISTRAR PACIENTE";
                btn.disabled = false;
            }
        };
    </script>
</body>
</html>
