<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>HC NUBE | REGISTRO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8fafc; font-family: sans-serif; }
        .card-reg { max-width: 450px; margin: 50px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-green { background: #22c55e; color: white; border: none; width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; }
    </style>
</head>
<body>
<div class="card-reg">
    <div class="text-center mb-4">
        <img src="https://ingerutonny-ui.github.io/HISTORIAL_CLINICO_NUBE/logo.png" height="50">
        <h5 class="mt-2">REGISTRO DE PACIENTE</h5>
    </div>
    <div class="mb-3">
        <label class="small fw-bold">NOMBRES</label>
        <input type="text" id="nombres" class="form-control" oninput="generar()">
    </div>
    <div class="mb-3">
        <label class="small fw-bold">APELLIDOS</label>
        <input type="text" id="apellidos" class="form-control" oninput="generar()">
    </div>
    <div class="mb-3">
        <label class="small fw-bold">CI</label>
        <input type="number" id="ci" class="form-control" oninput="generar()">
    </div>
    <div class="p-3 bg-light border text-center mb-3">
        <small>CÓDIGO:</small> <span id="cod" class="fw-bold">----</span>
    </div>
    <button class="btn-green" id="btnG" onclick="enviar()">GUARDAR REGISTRO FINAL</button>
</div>

<script>
    const API = 'https://historial-clinico-936s.onrender.com';

    function generar() {
        const n = document.getElementById('nombres').value;
        const a = document.getElementById('apellidos').value;
        const c = document.getElementById('ci').value;
        if(n && a && c) {
            document.getElementById('cod').innerText = n[0].toUpperCase() + a[0].toUpperCase() + c.slice(-4);
        }
    }

    async function enviar() {
        const btn = document.getElementById('btnG');
        const payload = {
            nombre: document.getElementById('nombres').value.toUpperCase(),
            apellido: document.getElementById('apellidos').value.toUpperCase(),
            ci: document.getElementById('ci').value,
            codigo_paciente: document.getElementById('cod').innerText
        };

        btn.innerText = "PROCESANDO...";
        try {
            const res = await fetch(`${API}/pacientes/`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if(res.ok) {
                const data = await res.json();
                localStorage.setItem('paciente_id', data.id);
                window.location.href = "declaracion_jurada_p1.html";
            } else { alert("Error en el servidor"); }
        } catch(e) { alert("Error de conexión"); }
        finally { btn.innerText = "GUARDAR REGISTRO FINAL"; }
    }
</script>
</body>
</html>
