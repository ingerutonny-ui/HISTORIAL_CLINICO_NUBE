<script>
        // CAMBIO CRÍTICO: Eliminamos la subruta /pacientes de la base para probar la conexión directa
        const API_BASE = 'https://historial-clinico-936s.onrender.com';

        document.getElementById('fechaActual').innerText = new Date().toLocaleDateString('es-ES', { 
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
        }).toUpperCase();

        const inputNombres = document.getElementById('nombres');
        const inputApellidos = document.getElementById('apellidos');
        const codigoDisplay = document.getElementById('codigo_display');

        function generarCodigo() {
            const n = inputNombres.value.trim().substring(0,1).toUpperCase();
            const a = inputApellidos.value.trim().substring(0,1).toUpperCase();
            if (n && a) {
                const num = Math.floor(1000 + Math.random() * 9000);
                codigoDisplay.value = n + a + num;
                codigoDisplay.style.display = 'block';
                document.getElementById('label_codigo').style.display = 'block';
            }
        }
        inputNombres.oninput = generarCodigo;
        inputApellidos.oninput = generarCodigo;

        document.getElementById('formRegistro').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnRegistrar');
            btn.innerText = 'CONECTANDO...';
            btn.disabled = true;

            const datos = {
                nombres: inputNombres.value,
                apellidos: inputApellidos.value,
                documento_identidad: document.getElementById('ci').value,
                codigo_paciente: codigoDisplay.value
            };

            try {
                // Probamos la ruta con el slash final exacto que pide FastAPI
                const res = await fetch(`${API_BASE}/pacientes/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });

                if (res.ok) {
                    alert("PACIENTE REGISTRADO EN LA NUBE");
                    location.reload();
                } else {
                    const err = await res.json();
                    alert("SERVIDOR DICE: " + (err.detail || "Error de datos"));
                }
            } catch (e) {
                // Si esto sale, es que el navegador sigue bloqueando la IP de Render
                alert("EL NAVEGADOR BLOQUEA LA RED. Intenta abrir la página en Modo Incógnito.");
            } finally {
                btn.innerText = 'REGISTRAR PACIENTE';
                btn.disabled = false;
            }
        };

        // Botón de consulta
        document.getElementById('btnToggleDB').onclick = async () => {
            const lista = document.getElementById('listaContenido');
            const seccion = document.getElementById('seccionLista');
            try {
                const res = await fetch(`${API_BASE}/pacientes`);
                const data = await res.json();
                lista.innerHTML = data.map(p => `
                    <div style="background:white; padding:10px; margin-bottom:5px; border-radius:10px; border:1px solid #eee; display:flex; justify-content:space-between;">
                        <span>${p.nombres} ${p.apellidos}</span>
                        <b style="color:blue">${p.codigo_paciente}</b>
                    </div>`).join('');
                seccion.style.display = 'block';
            } catch (e) {
                alert("No se puede leer la base de datos.");
            }
        };
    </script>
