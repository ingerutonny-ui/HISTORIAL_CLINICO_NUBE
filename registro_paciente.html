<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HC NUBE | REGISTRO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .registro-card { max-width: 500px; margin: 50px auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .logo-container { text-align: center; margin-bottom: 20px; }
        .form-label { font-size: 0.8rem; font-weight: 700; color: #64748b; text-transform: uppercase; }
        .form-control { border-radius: 10px; padding: 12px; border: 1px solid #e2e8f0; background-color: #f8fafc; }
        .btn-primary { background-color: #22c55e; border: none; border-radius: 12px; padding: 15px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s; }
        .btn-primary:hover { background-color: #16a34a; transform: translateY(-2px); }
        .codigo-box { background: #f1f5f9; border: 2px dashed #cbd5e1; border-radius: 12px; padding: 15px; text-align: center; margin: 20px 0; }
        .codigo-text { font-size: 1.5rem; font-weight: 800; color: #1e293b; }
    </style>
</head>
<body>

<div class="container">
    <div class="registro-card">
        <div class="logo-container">
            <img src="https://ingerutonny-ui.github.io/HISTORIAL_CLINICO_NUBE/logo.png" alt="Logo" height="60">
            <h2 class="mt-3" style="font-size: 1.2rem; font-weight: 800; color: #1e293b;">REGISTRO DE PACIENTE</h2>
            <p class="text-muted" style="font-size: 0.9rem;">MÓDULO DE ENFERMERÍA</p>
        </div>

        <div class="mb-3">
            <label class="form-label">Nombres</label>
            <input type="text" id="nombres" class="form-control" placeholder="Ej. MARIA" oninput="generarCodigo()">
        </div>

        <div class="mb-3">
            <label class="form-label">Apellidos</label>
            <input type="text" id="apellidos" class="form-control" placeholder="Ej. VELINDA" oninput="generarCodigo()">
        </div>

        <div class="mb-3">
            <label class="form-label">Documento de Identidad (CI)</label>
            <input type="number" id="ci" class="form-control" placeholder="Ingrese CI" oninput="generarCodigo()">
        </div>

        <div class="codigo-box">
            <label class="form-label">Código Generado</label>
            <div id="codigo_paciente" class="codigo-text">----</div>
        </div>

        <button class="btn btn-primary w-100" id="btnGuardar" onclick="guardarPaciente()">Procesando...</button>
        
        <div class="mt-4 text-center">
            <a href="#" onclick="cargarPacientes()" style="font-size: 0.8rem; color: #64748b; text-decoration: none; font-weight: 600;">CONSULTAR REGISTROS EN NUBE</a>
        </div>

        <div id="listaPacientes" class="mt-3" style="display:none; max-height: 200px; overflow-y: auto;">
            </div>
    </div>
</div>

<script>
    const API_URL = 'https://historial-clinico-936s.onrender.com';

    function generarCodigo() {
        const nombres = document.getElementById('nombres').value.trim();
        const apellidos = document.getElementById('apellidos').value.trim();
        const ci = document.getElementById('ci').value.trim();
        
        if (nombres && apellidos && ci) {
            const inicialNombre = nombres.charAt(0).toUpperCase();
            const inicialApellido = apellidos.charAt(0).toUpperCase();
            const ultimosCI = ci.slice(-4);
            document.getElementById('codigo_paciente').innerText = `${inicialNombre}${inicialApellido}${ultimosCI}`;
            document.getElementById('btnGuardar').innerText = "GUARDAR REGISTRO FINAL";
        }
    }

    async function guardarPaciente() {
        const btn = document.getElementById('btnGuardar');
        const payload = {
            nombre: document.getElementById('nombres').value.toUpperCase(),
            apellido: document.getElementById('apellidos').value.toUpperCase(),
            ci: document.getElementById('ci').value,
            codigo_paciente: document.getElementById('codigo_paciente').innerText
        };

        if (!payload.nombre || !payload.apellido || !payload.ci || payload.codigo_paciente === "----") {
            alert("Por favor complete todos los campos");
            return;
        }

        btn.innerText = "PROCESANDO...";
        btn.disabled = true;

        try {
            const response = await fetch(`${API_URL}/pacientes/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                const paciente = await response.json();
                localStorage.setItem('paciente_id', paciente.id);
                localStorage.setItem('paciente_nombre', `${payload.nombre} ${payload.apellido}`);
                localStorage.setItem('paciente_ci', payload.ci);
                localStorage.setItem('paciente_codigo', payload.codigo_paciente);
                window.location.href = "declaracion_jurada_p1.html";
            } else {
                const err = await response.json();
                alert("Error: " + JSON.stringify(err.detail));
            }
        } catch (error) {
            alert("Error crítico de conexión.");
        } finally {
            btn.disabled = false;
            btn.innerText = "GUARDAR REGISTRO FINAL";
        }
    }

    async function cargarPacientes() {
        const lista = document.getElementById('listaPacientes');
        lista.style.display = 'block';
        lista.innerHTML = '<p class="text-center" style="font-size:0.7rem;">CARGANDO...</p>';
        
        try {
            const res = await fetch(`${API_URL}/pacientes/`);
            const data = await res.json();
            lista.innerHTML = '<p style="font-size:0.7rem; font-weight:bold; border-bottom:1px solid #eee;">PACIENTES EN NUBE:</p>' + 
                data.map(p => `<div style="font-size:0.7rem; padding:5px; border-bottom:1px solid #f8fafc;">
                    ${p.nombre} ${p.apellido} <span class="badge bg-success float-end">${p.codigo_paciente}</span>
                </div>`).join('');
        } catch (e) {
            lista.innerHTML = '<p class="text-danger" style="font-size:0.7rem;">ERROR AL CARGAR</p>';
        }
    }
</script>
</body>
</html>
