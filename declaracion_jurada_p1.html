<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HC NUBE | FILIACIÓN (1/3)</title>
    <style>
        :root { --primary: #005a2b; --secondary: #00a651; --bg: #0b0f19; --card: #161b22; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #c9d1d9; }
        .container { max-width: 1100px; margin: auto; background: var(--card); padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border-top: 5px solid var(--secondary); }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid #30363d; padding-bottom: 20px; }
        .header img { height: 50px; }
        .header h2 { color: #fff; margin: 0; font-style: italic; font-weight: 800; letter-spacing: 1px; }

        .info-paciente { background: #0d1117; padding: 20px; border-radius: 8px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; border: 1px solid #30363d; }
        .info-paciente div { font-size: 0.8em; color: #8b949e; text-transform: uppercase; }
        .info-paciente strong { color: #fff; font-weight: bold; display: block; margin-top: 5px; font-size: 1.1em; }

        .grid-form { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .field { display: flex; flex-direction: column; }
        label { font-size: 0.75em; font-weight: bold; margin-bottom: 8px; color: #8b949e; text-transform: uppercase; }
        
        input, select { padding: 12px; border: 1px solid #30363d; border-radius: 6px; font-size: 1em; background: #0d1117; color: #fff; transition: 0.3s; }
        input:focus { border-color: #58a6ff; outline: none; box-shadow: 0 0 0 3px rgba(88,166,255,0.3); }
        
        .full-width { grid-column: span 3; }
        .btn-submit { margin-top: 30px; width: 100%; padding: 18px; background: #238636; color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: 0.3s; text-transform: uppercase; }
        .btn-submit:hover { background: #2ea043; }
        .btn-submit:disabled { background: #21262d; color: #484f58; cursor: not-allowed; }

        @media (max-width: 768px) {
            .grid-form { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
            .info-paciente { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="logo.png" alt="Logo OHS">
        <h2>1. DATOS DE FILIACIÓN</h2>
    </div>

    <div class="info-paciente">
        <div>PACIENTE: <strong id="disp_nombre">---</strong></div>
        <div>CI: <strong id="disp_ci">---</strong></div>
        <div>CÓDIGO: <strong id="disp_codigo">---</strong></div>
    </div>

    <form id="form-filiacion" class="grid-form">
        <div class="field">
            <label>Edad</label>
            <input type="number" name="edad" required>
        </div>
        <div class="field">
            <label>Sexo</label>
            <select name="sexo" required>
                <option value="">SELECCIONE...</option>
                <option value="MASCULINO">MASCULINO</option>
                <option value="FEMENINO">FEMENINO</option>
            </select>
        </div>
        <div class="field">
            <label>Fecha Nacimiento</label>
            <input type="date" name="fecha_nacimiento" required>
        </div>

        <div class="field full-width">
            <label>Lugar de Nacimiento</label>
            <input type="text" name="lugar_nacimiento" required>
        </div>

        <div class="field full-width">
            <label>Domicilio Actual</label>
            <input type="text" name="domicilio" required>
        </div>

        <div class="field">
            <label>N° Casa</label>
            <input type="text" name="n_casa">
        </div>
        <div class="field">
            <label>Zona / Barrio</label>
            <input type="text" name="zona_barrio">
        </div>
        <div class="field">
            <label>Ciudad</label>
            <input type="text" name="ciudad" required>
        </div>

        <div class="field">
            <label>País</label>
            <input type="text" name="pais" value="BOLIVIA">
        </div>
        <div class="field">
            <label>Teléfono/Celular</label>
            <input type="text" name="telefono" required>
        </div>
        <div class="field">
            <label>Estado Civil</label>
            <select name="estado_civil">
                <option value="SOLTERO/A">SOLTERO/A</option>
                <option value="CASADO/A">CASADO/A</option>
                <option value="DIVORCIADO/A">DIVORCIADO/A</option>
                <option value="VIUDO/A">VIUDO/A</option>
                <option value="CONVIVIENTE">CONVIVIENTE</option>
            </select>
        </div>

        <div class="field full-width">
            <label>Profesión / Oficio</label>
            <input type="text" name="profesion_oficio">
        </div>

        <button type="submit" id="btn-procesar" class="btn-submit">GUARDAR Y CONTINUAR AL PASO 2</button>
    </form>
</div>

<script>
    const API_URL = "https://historial-clinico-936s.onrender.com";
    
    // Verificación de datos guardados por buscador_codigo.html
    const pacienteStr = localStorage.getItem('paciente_actual');
    const pacienteData = pacienteStr ? JSON.parse(pacienteStr) : null;

    if (pacienteData) {
        document.getElementById('disp_nombre').textContent = (pacienteData.nombre + " " + pacienteData.apellido).toUpperCase();
        document.getElementById('disp_ci').textContent = pacienteData.ci;
        document.getElementById('disp_codigo').textContent = pacienteData.codigo_paciente;
    } else {
        alert("Error: Sesión de paciente no encontrada. Por favor inicie desde el buscador.");
        window.location.href = "buscador_codigo.html";
    }

    document.getElementById('form-filiacion').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btn-procesar');
        btn.disabled = true;
        btn.textContent = "PROCESANDO...";

        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        // El ID debe ser el que devolvió el Backend en el buscador
        data.paciente_id = parseInt(pacienteData.id);

        try {
            const response = await fetch(`${API_URL}/filiacion/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                window.location.href = "declaracion_jurada_p2.html";
            } else {
                const errorData = await response.json();
                alert("Error al guardar filiación: " + (errorData.detail || "Verifique los datos"));
                btn.disabled = false;
                btn.textContent = "GUARDAR Y CONTINUAR AL PASO 2";
            }
        } catch (error) {
            alert("Error de conexión: " + error.message);
            btn.disabled = false;
            btn.textContent = "GUARDAR Y CONTINUAR AL PASO 2";
        }
    });
</script>

</body>
</html>
