<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HC NUBE | FILIACIÓN (1/3)</title>
    <style>
        :root { --primary: #005a2b; --secondary: #00a651; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; margin: 0; padding: 20px; color: white; }
        .container { max-width: 1000px; margin: auto; background: #2d2d2d; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border-top: 10px solid var(--secondary); }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 3px solid #444; padding-bottom: 20px; }
        .header img { height: 70px; filter: brightness(1.2); }
        .header h2 { color: var(--secondary); margin: 0; text-transform: uppercase; letter-spacing: 2px; font-size: 1.8em; }

        .info-paciente { background: #3d3d3d; padding: 20px; border-radius: 10px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; border: 1px solid #555; }
        .info-paciente div { font-size: 0.9em; color: #bbb; text-transform: uppercase; }
        .info-paciente strong { color: #fff; font-weight: 800; display: block; margin-top: 5px; font-size: 1.1em; }

        .grid-form { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .field { display: flex; flex-direction: column; }
        label { font-size: 0.75em; font-weight: bold; margin-bottom: 8px; color: var(--secondary); text-transform: uppercase; }
        
        input, select { padding: 12px; border: 2px solid #444; border-radius: 8px; font-size: 1em; background: #1a1a1a; color: white; transition: 0.3s; }
        input:focus, select:focus { border-color: var(--secondary); outline: none; box-shadow: 0 0 8px rgba(0,166,81,0.4); }
        
        .full-width { grid-column: span 3; }
        .btn-submit { margin-top: 40px; width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 1.3em; font-weight: bold; cursor: pointer; transition: 0.4s; text-transform: uppercase; letter-spacing: 1px; }
        .btn-submit:hover { background: var(--secondary); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,166,81,0.4); }
        .btn-submit:disabled { background: #143a23; color: #666; cursor: not-allowed; transform: none; }

        @media (max-width: 768px) {
            .grid-form { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
            .info-paciente { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="logo.png" alt="Logo OHS">
        <h2>1. DATOS DE FILIACIÓN</h2>
    </div>

    <div class="info-paciente">
        <div>PACIENTE <strong id="disp_nombre">CARGANDO...</strong></div>
        <div>CÉDULA DE IDENTIDAD <strong id="disp_ci">---</strong></div>
        <div>CÓDIGO <strong id="disp_codigo">---</strong></div>
    </div>

    <form id="form-filiacion" class="grid-form">
        <div class="field">
            <label>Edad</label>
            <input type="number" name="edad" required>
        </div>
        <div class="field">
            <label>Sexo</label>
            <select name="sexo" required>
                <option value="">SELECCIONE...</option>
                <option value="MASCULINO">MASCULINO</option>
                <option value="FEMENINO">FEMENINO</option>
            </select>
        </div>
        <div class="field">
            <label>Fecha Nacimiento</label>
            <input type="date" name="fecha_nacimiento" required>
        </div>

        <div class="field full-width">
            <label>Lugar de Nacimiento</label>
            <input type="text" name="lugar_nacimiento" required>
        </div>

        <div class="field full-width">
            <label>Domicilio Actual</label>
            <input type="text" name="domicilio" required>
        </div>

        <div class="field">
            <label>N° Casa</label>
            <input type="text" name="n_casa">
        </div>
        <div class="field">
            <label>Zona / Barrio</label>
            <input type="text" name="zona_barrio">
        </div>
        <div class="field">
            <label>Ciudad</label>
            <input type="text" name="ciudad" required>
        </div>

        <div class="field">
            <label>País</label>
            <input type="text" name="pais" value="BOLIVIA">
        </div>
        <div class="field">
            <label>Teléfono/Celular</label>
            <input type="text" name="telefono" required>
        </div>
        <div class="field">
            <label>Estado Civil</label>
            <select name="estado_civil">
                <option value="SOLTERO/A">SOLTERO/A</option>
                <option value="CASADO/A">CASADO/A</option>
                <option value="DIVORCIADO/A">DIVORCIADO/A</option>
                <option value="VIUDO/A">VIUDO/A</option>
                <option value="CONVIVIENTE">CONVIVIENTE</option>
            </select>
        </div>

        <div class="field full-width">
            <label>Profesión / Oficio</label>
            <input type="text" name="profesion_oficio">
        </div>

        <button type="submit" id="btn-procesar" class="btn-submit">PROCESANDO...</button>
    </form>
</div>

<script>
    const API_URL = "https://historial-clinico-936s.onrender.com";
    
    // Recuperar datos con la clave exacta usada en el buscador
    const pacienteData = JSON.parse(localStorage.getItem('paciente_actual'));

    if (pacienteData) {
        document.getElementById('disp_nombre').textContent = `${pacienteData.nombre} ${pacienteData.apellido}`.toUpperCase();
        document.getElementById('disp_ci').textContent = pacienteData.ci;
        document.getElementById('disp_codigo').textContent = pacienteData.codigo_paciente;
    } else {
        alert("Sesión de paciente no encontrada. Regresando al buscador.");
        window.location.href = "buscador_codigo.html";
    }

    document.getElementById('form-filiacion').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btn-procesar');
        btn.disabled = true;

        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        // El ID debe ser entero para evitar el error 400
        data.paciente_id = parseInt(pacienteData.id);

        try {
            const response = await fetch(`${API_URL}/filiacion/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                window.location.href = "declaracion_jurada_p2.html";
            } else {
                const err = await response.json();
                alert("Error al guardar: " + JSON.stringify(err.detail));
                btn.disabled = false;
            }
        } catch (error) {
            alert("Error de conexión con el servidor.");
            btn.disabled = false;
        }
    });

    // Cambiar texto de botón al inicio
    document.getElementById('btn-procesar').textContent = "GUARDAR Y CONTINUAR A P2";
</script>

</body>
</html>
