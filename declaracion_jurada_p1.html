<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HC NUBE | FILIACI√ìN (1/3)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f4f8; font-family: 'Segoe UI', sans-serif; padding: 10px; }
        .form-container { max-width: 950px; margin: 15px auto; background: white; padding: 25px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.06); }
        .header-ohs { display: flex; align-items: center; justify-content: space-between; border-bottom: 3px solid #22c55e; padding-bottom: 15px; margin-bottom: 20px; }
        .title-center h2 { font-size: 1.2rem; font-weight: 800; color: #1e293b; text-transform: uppercase; margin: 0; }
        .data-banner { background: #f8fafc; padding: 15px; border-radius: 15px; margin-bottom: 25px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: space-around; border: 1px solid #e2e8f0; }
        .data-item { font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; }
        .data-val { color: #1e293b; font-weight: 900; display: block; font-size: 13px; }
        .label-custom { font-size: 11px; font-weight: 800; color: #475569; text-transform: uppercase; margin-bottom: 6px; padding-left: 2px; }
        .form-control, .form-select { border-radius: 12px; padding: 14px; font-size: 15px; text-transform: uppercase; background: #fdfdfd; border: 2px solid #f1f5f9; font-weight: 600; }
        .form-control:focus { border-color: #22c55e; box-shadow: none; background: white; }
        .btn-next { background: #22c55e; color: white; border: none; padding: 20px; border-radius: 15px; width: 100%; font-weight: 800; text-transform: uppercase; margin-top: 25px; font-size: 16px; box-shadow: 0 10px 20px rgba(34, 197, 94, 0.2); transition: 0.3s; }
        .btn-next:hover { background: #16a34a; transform: translateY(-2px); }
        @media (max-width: 768px) { .form-container { padding: 20px 15px; border-radius: 20px; } .header-ohs img { height: 40px; } .title-center h2 { font-size: 1rem; } .data-banner { flex-direction: column; align-items: flex-start; } .form-control, .form-select { padding: 16px; font-size: 16px; } }
    </style>
</head>
<body>

<div class="form-container">
    <div class="header-ohs">
        <img src="https://ingerutonny-ui.github.io/HISTORIAL_CLINICO_NUBE/logo.png" height="50">
        <div class="title-center"><h2>1. Datos de Filiaci√≥n</h2></div>
        <div id="modo-indicador" style="font-size: 10px; font-weight: 800; color: #22c55e; text-align: right;">NUEVO REGISTRO</div>
    </div>

    <div class="data-banner shadow-sm">
        <div class="data-item">PACIENTE: <span id="p_nombre" class="data-val">---</span></div>
        <div class="data-item">CI: <span id="p_ci" class="data-val">---</span></div>
        <div class="data-item">C√ìDIGO: <span id="p_codigo" class="data-val">---</span></div>
    </div>

    <form id="formP1" class="row g-3">
        <div class="col-6 col-md-3"><label class="label-custom">Edad</label><input type="number" id="edad" class="form-control" required></div>
        <div class="col-6 col-md-3">
            <label class="label-custom">Sexo</label>
            <select id="sexo" class="form-select">
                <option value="MASCULINO">MASCULINO</option>
                <option value="FEMENINO">FEMENINO</option>
            </select>
        </div>
        <div class="col-12 col-md-3"><label class="label-custom">Fecha Nacimiento</label><input type="date" id="fecha_nac" class="form-control" required></div>
        <div class="col-12 col-md-3"><label class="label-custom">Lugar Nacimiento</label><input type="text" id="lugar_nac" class="form-control" oninput="this.value=this.value.toUpperCase()"></div>
        
        <div class="col-12 col-md-6"><label class="label-custom">Domicilio Actual</label><input type="text" id="domicilio" class="form-control" oninput="this.value=this.value.toUpperCase()"></div>
        <div class="col-6 col-md-2"><label class="label-custom">N¬∞ Casa</label><input type="text" id="n_casa" class="form-control"></div>
        <div class="col-6 col-md-4"><label class="label-custom">Zona / Barrio</label><input type="text" id="zona" class="form-control" oninput="this.value=this.value.toUpperCase()"></div>
        
        <div class="col-12 col-md-4"><label class="label-custom">Ciudad</label><input type="text" id="ciudad" class="form-control" oninput="this.value=this.value.toUpperCase()"></div>
        <div class="col-6 col-md-4"><label class="label-custom">Pa√≠s</label><input type="text" id="pais" class="form-control" value="BOLIVIA" oninput="this.value=this.value.toUpperCase()"></div>
        <div class="col-6 col-md-4"><label class="label-custom">Tel√©fono/Celular</label><input type="text" id="tel" class="form-control"></div>
        
        <div class="col-12 col-md-6">
            <label class="label-custom">Estado Civil</label>
            <select id="est_civil" class="form-select">
                <option value="SOLTERO/A">SOLTERO/A</option>
                <option value="CASADO/A">CASADO/A</option>
                <option value="DIVORCIADO/A">DIVORCIADO/A</option>
                <option value="VIUDO/A">VIUDO/A</option>
            </select>
        </div>
        <div class="col-12 col-md-6"><label class="label-custom">Profesi√≥n / Oficio</label><input type="text" id="profesion" class="form-control" oninput="this.value=this.value.toUpperCase()"></div>

        <button type="submit" id="btnNext" class="btn-next">üíæ Guardar y Continuar a Parte 2</button>
    </form>
</div>

<script>
    const API = 'https://historial-clinico-936s.onrender.com';

    window.onload = async () => {
        // INGE: Detectamos si es edici√≥n o registro nuevo
        const p_id_edicion = localStorage.getItem('p_id_edicion');
        const p_id_registro = localStorage.getItem('p_id');
        const id_trabajo = p_id_edicion || p_id_registro;

        if (!id_trabajo) { 
            alert("‚ö†Ô∏è Inge, no hay un paciente seleccionado."); 
            window.location.href = "lista_historial.html";
            return; 
        }

        // Cargamos datos del banner (Paciente/CI/C√≥digo)
        try {
            const resp = await fetch(`${API}/api/paciente-completo/${id_trabajo}`);
            const data = await resp.json();
            
            document.getElementById('p_nombre').innerText = `${data.paciente.apellido} ${data.paciente.nombre}`;
            document.getElementById('p_ci').innerText = data.paciente.ci;
            document.getElementById('p_codigo').innerText = data.paciente.codigo_paciente;

            // INGE: Si hay datos en 'filiacion', los rellenamos (MODO EDICI√ìN)
            if (data.filiacion && data.filiacion.paciente_id) {
                document.getElementById('modo-indicador').innerText = "MODO EDICI√ìN";
                document.getElementById('modo-indicador').style.color = "#f59e0b";
                document.getElementById('edad').value = data.filiacion.edad || '';
                document.getElementById('sexo').value = data.filiacion.sexo || 'MASCULINO';
                document.getElementById('fecha_nac').value = data.filiacion.fecha_nacimiento || '';
                document.getElementById('lugar_nac').value = data.filiacion.lugar_nacimiento || '';
                document.getElementById('domicilio').value = data.filiacion.domicilio || '';
                document.getElementById('n_casa').value = data.filiacion.n_casa || '';
                document.getElementById('zona').value = data.filiacion.zona_barrio || '';
                document.getElementById('ciudad').value = data.filiacion.ciudad || '';
                document.getElementById('pais').value = data.filiacion.pais || 'BOLIVIA';
                document.getElementById('tel').value = data.filiacion.telefono || '';
                document.getElementById('est_civil').value = data.filiacion.estado_civil || 'SOLTERO/A';
                document.getElementById('profesion').value = data.filiacion.profesion_oficio || '';
            }
        } catch (err) {
            console.error("Error al cargar datos:", err);
        }
    };

    document.getElementById('formP1').onsubmit = async (e) => {
        e.preventDefault();
        const id_trabajo = localStorage.getItem('p_id_edicion') || localStorage.getItem('p_id');
        const btn = document.getElementById('btnNext');
        btn.innerText = "‚è≥ PROCESANDO..."; btn.disabled = true;

        const data = {
            paciente_id: parseInt(id_trabajo),
            edad: document.getElementById('edad').value,
            sexo: document.getElementById('sexo').value,
            fecha_nacimiento: document.getElementById('fecha_nac').value,
            lugar_nacimiento: document.getElementById('lugar_nac').value,
            domicilio: document.getElementById('domicilio').value,
            n_casa: document.getElementById('n_casa').value,
            zona_barrio: document.getElementById('zona').value,
            ciudad: document.getElementById('ciudad').value,
            pais: document.getElementById('pais').value,
            telefono: document.getElementById('tel').value,
            estado_civil: document.getElementById('est_civil').value,
            profesion_oficio: document.getElementById('profesion').value
        };

        try {
            const r = await fetch(`${API}/filiacion/`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if(r.ok) {
                window.location.href = "declaracion_jurada_p2.html";
            } else {
                alert("‚ùå Fallo al guardar.");
            }
        } catch(e) { 
            alert("‚ùå Sin conexi√≥n."); 
        } finally { 
            btn.disabled = false; 
            btn.innerText = "üíæ Guardar y Continuar a Parte 2"; 
        }
    };
</script>
</body>
</html>
