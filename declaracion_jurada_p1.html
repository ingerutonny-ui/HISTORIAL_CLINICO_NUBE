<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HC NUBE | FILIACIÓN (1/3)</title>
    <style>
        :root { --primary: #005a2b; --secondary: #00a651; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 10px solid var(--primary); }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 3px solid #eee; padding-bottom: 20px; }
        .header img { height: 70px; }
        .header h2 { color: var(--primary); margin: 0; text-transform: uppercase; letter-spacing: 2px; font-size: 1.8em; }

        .info-paciente { background: #f0f4f2; padding: 20px; border-radius: 10px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; border: 1px solid #c8d6cf; }
        .info-paciente div { font-size: 1em; color: #333; }
        .info-paciente strong { color: #000; font-weight: 800; display: block; margin-top: 5px; }

        .grid-form { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .field { display: flex; flex-direction: column; }
        label { font-size: 0.8em; font-weight: bold; margin-bottom: 8px; color: var(--primary); text-transform: uppercase; }
        
        input, select { padding: 12px; border: 2px solid #e1e1e1; border-radius: 8px; font-size: 1em; background: #fff; transition: 0.3s; }
        input:focus, select:focus { border-color: var(--secondary); outline: none; box-shadow: 0 0 8px rgba(0,166,81,0.15); }
        
        .full-width { grid-column: span 3; }
        .btn-submit { margin-top: 40px; width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 1.3em; font-weight: bold; cursor: pointer; transition: 0.4s; text-transform: uppercase; letter-spacing: 1px; }
        .btn-submit:hover { background: var(--secondary); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,90,43,0.3); }
        .btn-submit:disabled { background: #777; cursor: not-allowed; transform: none; }

        /* Estilos responsivos restaurados */
        @media (max-width: 768px) {
            .grid-form { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
            .info-paciente { grid-template-columns: 1fr; }
            .container { padding: 20px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="logo.png" alt="Logo OHS">
        <h2>1. DATOS DE FILIACIÓN</h2>
    </div>

    <div class="info-paciente">
        <div>PACIENTE <strong id="disp_nombre">---</strong></div>
        <div>CÉDULA DE IDENTIDAD <strong id="disp_ci">---</strong></div>
        <div>CÓDIGO SISTEMA <strong id="disp_codigo">---</strong></div>
    </div>

    <form id="form-filiacion" class="grid-form">
        <div class="field">
            <label>Edad (Años)</label>
            <input type="number" name="edad" placeholder="00" required>
        </div>
        <div class="field">
            <label>Sexo</label>
            <select name="sexo" required>
                <option value="">SELECCIONE...</option>
                <option value="MASCULINO">MASCULINO</option>
                <option value="FEMENINO">FEMENINO</option>
                <option value="OTRO">OTRO</option>
            </select>
        </div>
        <div class="field">
            <label>Fecha de Nacimiento</label>
            <input type="date" name="fecha_nacimiento" required>
        </div>

        <div class="field full-width">
            <label>Lugar de Nacimiento</label>
            <input type="text" name="lugar_nacimiento" placeholder="Departamento / Provincia / Localidad" required>
        </div>

        <div class="field full-width">
            <label>Domicilio Actual (Dirección Completa)</label>
            <input type="text" name="domicilio" placeholder="Calle, Avenida, Edificio" required>
        </div>

        <div class="field">
            <label>N° de Casa / Depto</label>
            <input type="text" name="n_casa" placeholder="Ej: 123">
        </div>
        <div class="field">
            <label>Zona / Barrio</label>
            <input type="text" name="zona_barrio" placeholder="Nombre de la zona">
        </div>
        <div class="field">
            <label>Ciudad / Municipio</label>
            <input type="text" name="ciudad" placeholder="Ej: El Alto" required>
        </div>

        <div class="field">
            <label>País</label>
            <input type="text" name="pais" value="BOLIVIA" required>
        </div>
        <div class="field">
            <label>Teléfono / Celular de contacto</label>
            <input type="text" name="telefono" placeholder="Ej: 70000000" required>
        </div>
        <div class="field">
            <label>Estado Civil</label>
            <select name="estado_civil" required>
                <option value="SOLTERO/A">SOLTERO/A</option>
                <option value="CASADO/A">CASADO/A</option>
                <option value="DIVORCIADO/A">DIVORCIADO/A</option>
                <option value="VIUDO/A">VIUDO/A</option>
                <option value="CONVIVIENTE">CONVIVIENTE / UNIÓN LIBRE</option>
            </select>
        </div>

        <div class="field full-width">
            <label>Profesión / Ocupación u Oficio</label>
            <input type="text" name="profesion_oficio" placeholder="Describa su actividad laboral actual">
        </div>

        <button type="submit" id="btn-procesar" class="btn-submit">GUARDAR Y CONTINUAR AL PASO 2</button>
    </form>
</div>

<script>
    const API_URL = "https://historial-clinico-936s.onrender.com";
    const pacienteData = JSON.parse(localStorage.getItem('paciente_actual'));

    // Carga inicial de datos persistidos
    if (pacienteData) {
        document.getElementById('disp_nombre').textContent = `${pacienteData.nombre} ${pacienteData.apellido}`.toUpperCase();
        document.getElementById('disp_ci').textContent = pacienteData.ci;
        document.getElementById('disp_codigo').textContent = pacienteData.codigo_paciente;
    } else {
        alert("Sesión de paciente no encontrada. Regresando al buscador.");
        window.location.href = "buscador_codigo.html";
    }

    document.getElementById('form-filiacion').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btn-procesar');
        btn.disabled = true;
        btn.textContent = "PROCESANDO INFORMACIÓN...";

        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        // El paciente_id es el vínculo con la tabla pacientes
        data.paciente_id = parseInt(pacienteData.id);

        try {
            const response = await fetch(`${API_URL}/filiacion/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                console.log("Datos de filiación guardados correctamente.");
                window.location.href = "declaracion_jurada_p2.html";
            } else {
                const errorLog = await response.json();
                alert("Error del Servidor: " + (errorLog.detail || "Error desconocido en el registro"));
                btn.disabled = false;
                btn.textContent = "GUARDAR Y CONTINUAR AL PASO 2";
            }
        } catch (error) {
            console.error("Error en la petición:", error);
            alert("Error de Conexión: Asegúrese de que el servidor en Render esté activo.");
            btn.disabled = false;
            btn.textContent = "GUARDAR Y CONTINUAR AL PASO 2";
        }
    });
</script>

</body>
</html>
