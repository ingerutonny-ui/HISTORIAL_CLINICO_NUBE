<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>CONSULTA DE HISTORIALES | HC NUBE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; }
        .container-consulta { max-width: 1100px; margin: 40px auto; background: white; padding: 35px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .header-title { border-bottom: 3px solid #22c55e; padding-bottom: 15px; margin-bottom: 30px; color: #1e293b; font-weight: 900; }
        .search-bar { border-radius: 50px; border: 2px solid #e2e8f0; padding: 12px 25px; margin-bottom: 25px; }
        .table-custom thead { background-color: #f1f5f9; text-transform: uppercase; font-size: 0.75rem; color: #64748b; }
        .btn-view { background: #1e293b; color: white; border-radius: 8px; font-size: 0.8rem; font-weight: 600; padding: 6px 15px; }
        .empty-state { text-align: center; padding: 40px; color: #94a3b8; border: 2px dashed #e2e8f0; border-radius: 15px; }
    </style>
</head>
<body>

<div class="container-consulta">
    <div class="header-title d-flex justify-content-between align-items-center">
        <span>ðŸ“‹ REGISTROS EN LA NUBE</span>
        <button class="btn btn-sm btn-success" onclick="obtenerPacientes()">ðŸ”„ REFRESCAR DATOS</button>
    </div>

    <input type="text" id="inputBusqueda" class="form-control search-bar" placeholder="Buscar por nombre, apellido o CI..." onkeyup="filtrarTabla()">

    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-custom">
                <tr>
                    <th>CÃ“DIGO</th>
                    <th>PACIENTE</th>
                    <th>CÃ‰DULA (CI)</th>
                    <th>ESTADO</th>
                    <th class="text-center">ACCIONES</th>
                </tr>
            </thead>
            <tbody id="listaPacientes">
                </tbody>
        </table>
    </div>

    <div id="sinDatos" class="empty-state" style="display: none;">
        <h5>No hay registros en la base de datos.</h5>
        <p>AsegÃºrese de haber completado el registro desde P1.</p>
    </div>
</div>

<script>
    const API_URL = 'https://historial-clinico-936s.onrender.com';

    async function obtenerPacientes() {
        const tbody = document.getElementById('listaPacientes');
        const emptyState = document.getElementById('sinDatos');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">Cargando datos desde Render...</td></tr>';
        
        try {
            const respuesta = await fetch(`${API_URL}/pacientes/`);
            if (!respuesta.ok) throw new Error("Error en servidor");
            
            const pacientes = await respuesta.json();
            
            if (pacientes.length === 0) {
                tbody.innerHTML = "";
                emptyState.style.display = "block";
                return;
            }

            emptyState.style.display = "none";
            tbody.innerHTML = "";
            
            pacientes.forEach(p => {
                const fila = `
                    <tr>
                        <td class="fw-bold text-success">${p.codigo_paciente}</td>
                        <td class="text-uppercase">${p.nombre} ${p.apellido}</td>
                        <td>${p.ci}</td>
                        <td><span class="badge bg-light text-dark border">REGISTRADO</span></td>
                        <td class="text-center">
                            <button class="btn btn-view" onclick="verFicha(${p.id})">VER FICHA</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += fila;
            });

        } catch (error) {
            tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error de conexiÃ³n: ${error.message}</td></tr>`;
        }
    }

    function filtrarTabla() {
        const busqueda = document.getElementById('inputBusqueda').value.toUpperCase();
        const filas = document.getElementById('listaPacientes').getElementsByTagName('tr');
        
        for (let i = 0; i < filas.length; i++) {
            const texto = filas[i].innerText.toUpperCase();
            filas[i].style.display = texto.includes(busqueda) ? "" : "none";
        }
    }

    function verFicha(id) {
        alert("Generando visualizaciÃ³n para el paciente ID: " + id);
    }

    // Ejecutar al cargar
    window.onload = obtenerPacientes;
</script>
</body>
</html>
